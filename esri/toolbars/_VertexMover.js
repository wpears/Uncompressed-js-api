/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define(["dijit","dojo","dojox","dojo/require!dojox/gfx/move"],function(_1,_2,_3){_2.provide("esri.toolbars._VertexMover");_2.require("dojox.gfx.move");_2.declare("esri.toolbars.VertexMover",null,{constructor:function(_4,_5,_6,_7,_8,_9,_a,_b){this.point=_4;this.symbol=_5;this.relatedGraphic=_6;this.segIndex=_7;this.ptIndex=_8;this.segLength=_9;this.editor=_a;this.map=_a.map;this._scratchGL=_a.toolbar._scratchGL;this._placeholder=_b||false;this._type=_6.geometry.type;this._init();this._enable();},refresh:function(_c){if(_c||this._needRefresh()){this._disable();this._enable();}},destroy:function(){this._disable();if(this.graphic){this._scratchGL.remove(this.graphic);}this.point=this.symbol=this.graphic=this.relatedGraphic=this.segIndex=this.ptIndex=this.segLength=this.editor=this.map=this._scratchGL=null;},_init:function(){var _d=new esri.geometry.Point(this.point.toJson());var _e=new esri.Graphic(_d,this.symbol);switch(this._type){case "multipoint":_e._shape=this.relatedGraphic.getDojoShape().children[this.ptIndex];break;case "polyline":case "polygon":this._scratchGL.add(_e);break;}this.graphic=_e;},_enable:function(){var _f=this.graphic.getDojoShape();if(_f){_f._hasMover=true;this._moveable=this._getMoveable(_f);var _10=_f.getEventSource();if(_10){_2.style(_10,"cursor",this.editor.toolbar._cursors[this._placeholder?"move-gv":"move-v"]);}}},_disable:function(){var _11=this._moveable;if(_11){_2.disconnect(this._startHandle);_2.disconnect(this._firstHandle);_2.disconnect(this._movingHandle);_2.disconnect(this._stopHandle);var _12=_11.shape;if(_12){var _13=_12.getEventSource();if(_13){_2.style(_13,"cursor",null);}}_11.destroy();this._moveable=null;}},_needRefresh:function(){var _14=this.graphic.getDojoShape(),_15=false;if(_14){switch(this._type){case "multipoint":var _16=this.relatedGraphic.getDojoShape();if(_16){var _17=_16.children[this.ptIndex];if(_14!==_17){_14=_17;this.graphic._shape=_14;_15=true;}}break;case "polyline":case "polygon":_15=!_14._hasMover;break;}}return _15;},_getMoveable:function(_18){var _19=new _3.gfx.Moveable(_18,_2.isMac&&_2.isFF&&!esri.isTouchEnabled&&{leftButtonOnly:true});this._startHandle=_2.connect(_19,"onMoveStart",this,this._moveStartHandler);this._firstHandle=_2.connect(_19,"onFirstMove",this,this._firstMoveHandler);this._movingHandle=_2.connect(_19,"onMoving",this,this._movingHandler);this._stopHandle=_2.connect(_19,"onMoveStop",this,this._moveStopHandler);return _19;},_getPtIndex:function(){return this.ptIndex+(this._placeholder?1:0);},_getInfo:function(){return {graphic:this.graphic,isGhost:this._placeholder,segmentIndex:this.segIndex,pointIndex:this._getPtIndex()};},_moveStartHandler:function(_1a){var map=this.map;if(map.snappingManager){map.snappingManager._setUpSnapping();}_1a.shape.moveToFront();this.constructor.onMoveStart(this);this.editor.toolbar.onVertexMoveStart(this.relatedGraphic,this._getInfo());},_firstMoveHandler:function(_1b){var _1c=_1b.shape;var _1d=this._getControlEdges();var _1e=this._scratchGL._div;var i,_1f=[],_20=_1b.host.shape._wrapOffsets[0]||0;for(i=0;i<_1d.length;i++){var _21=_1d[i];_21.x1+=_20;_21.x2+=_20;_1f.push([_1e.createLine({x1:_21.x1,y1:_21.y1,x2:_21.x2,y2:_21.y2}).setStroke(this.editor._lineStroke),_21.x1,_21.y1,_21.x2,_21.y2]);}_1c._lines=_1f;_1b.shape.moveToFront();this.constructor.onFirstMove(this);this.editor.toolbar.onVertexFirstMove(this.relatedGraphic,this._getInfo());},_movingHandler:function(_22){var _23=_22.shape,tx=_23.getTransform();var i,_24=_23._lines;for(i=0;i<_24.length;i++){var _25=_24[i];_25[0].setShape({x1:_25[1]+tx.dx,y1:_25[2]+tx.dy,x2:_25[3],y2:_25[4]});}this.editor.toolbar.onVertexMove(this.relatedGraphic,this._getInfo(),tx);},_moveStopHandler:function(_26){var _27=_26.shape,tx=_27.getTransform(),map=this.map;var _28=this.graphic;var i,_29=_27._lines;if(_29){for(i=0;i<_29.length;i++){_29[i][0].removeShape();}_27._lines=null;}var ph=false,_2a=true,_2b=this._getInfo();if(tx&&(tx.dx||tx.dy)){if(this._placeholder){this._placeholder=false;ph=true;}}else{_2a=false;}var _2c;if(this.map.snappingManager){_2c=this.map.snappingManager._snappingPoint;}var _2d=_2c||map.toMap(map.toScreen(_28.geometry).offset(tx.dx,tx.dy));if(this.map.snappingManager){this.map.snappingManager._killOffSnapping();}_27.setTransform(null);_28.setGeometry(_2d);this.constructor.onMoveStop(this,tx);this.editor.toolbar.onVertexMoveStop(this.relatedGraphic,_2b,tx);if(!_2a){this.editor.toolbar.onVertexClick(this.relatedGraphic,_2b);}if(ph){this.editor.toolbar.onVertexAdd(this.relatedGraphic,this._getInfo());}},_getControlEdges:function(){var map=this.map;var _2e=this.relatedGraphic.geometry;var _2f=this.segIndex,_30=this.ptIndex,_31=this.segLength;var _32=this._scratchGL._div;var _33=_32.getTransform();var sdx=_33.dx,sdy=_33.dy;var pt=map.toScreen(this.graphic.geometry);var x=pt.x-sdx,y=pt.y-sdy;var _34=[];var _35=this.editor._getControlPoints(this,_2e,_2f,_30,_31);if(_35[0]){_34.push({x1:x,y1:y,x2:_35[0].x-sdx,y2:_35[0].y-sdy});}if(_35[1]){_34.push({x1:x,y1:y,x2:_35[1].x-sdx,y2:_35[1].y-sdy});}return _34;}});_2.mixin(esri.toolbars.VertexMover,{onMoveStart:function(){},onFirstMove:function(){},onMoveStop:function(){}});});