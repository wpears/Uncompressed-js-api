/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define(["dijit","dojo","dojox","dojo/require!dojox/gfx/Moveable,dojox/gfx/matrix"],function(_1,_2,_3){_2.provide("esri.toolbars._Box");_2.require("dojox.gfx.Moveable");_2.require("dojox.gfx.matrix");_2.declare("esri.toolbars._Box",null,{constructor:function(_4,_5,_6,_7,_8){this._graphic=_4;this._map=_5;this._toolbar=_6;this._scale=_7;this._rotate=_8;this._defaultEventArgs={};this._scaleEvent="Scale";this._rotateEvent="Rotate";var _9=_6._options;this._markerSymbol=_9.boxHandleSymbol;this._lineSymbol=_9.boxLineSymbol;this._moveStartHandler=_2.hitch(this,this._moveStartHandler);this._firstMoveHandler=_2.hitch(this,this._firstMoveHandler);this._moveStopHandler=_2.hitch(this,this._moveStopHandler);this._moveHandler=_2.hitch(this,this._moveHandler);this._init();},destroy:function(){this._cleanUp();this._graphic=this._map=this._toolbar=this._markerSymbol=this._lineSymbol=null;},refresh:function(){this._draw();},suspend:function(){_2.forEach(this._getAllGraphics(),function(g){g.hide();});},resume:function(){_2.forEach(this._getAllGraphics(),function(g){g.show();});this._draw();},_init:function(){this._draw();},_cleanUp:function(){if(this._connects){_2.forEach(this._connects,_2.disconnect,_2);}var _a=this._toolbar._scratchGL;if(this._anchors){_2.forEach(this._anchors,function(_b){_a.remove(_b.graphic);var _c=_b.moveable;if(_c){_c.destroy();}});}if(this._box){_a.remove(this._box);}this._box=this._anchors=this._connects=null;},_draw:function(){if(!this._graphic.getDojoShape()){this._cleanUp();return;}var _d=this._map,_e=this._toolbar._scratchGL;var _f=this._getBoxCoords();var _10=new esri.geometry.Polyline(_d.spatialReference);var _11=_2.clone(_2.filter(_f,function(pt,_12){return (_12!==8&&_12%2===0);}));if(_11[0]){_11.push([_11[0][0],_11[0][1]]);}_10.addPath(_11);if(this._rotate){_10.addPath([_f[1],_f[8]]);}if(this._box){this._box.setGeometry(_10);}else{this._box=new esri.Graphic(_10,this._lineSymbol);_e.add(this._box);}if(this._anchors){_2.forEach(this._anchors,function(_13,_14){if(!this._scale){_14=8;}var _15=new esri.geometry.Point(_f[_14],_d.spatialReference);_13.graphic.setGeometry(_15);var mov=_13.moveable,_16=_13.graphic.getDojoShape();if(_16){if(!mov){_13.moveable=this._getMoveable(_13.graphic,_14);}else{if(_16!==mov.shape){mov.destroy();_13.moveable=this._getMoveable(_13.graphic,_14);}}}},this);}else{this._anchors=[];this._connects=[];_2.forEach(_f,function(_17,_18){if(!this._scale&&_18<8){return;}_17=new esri.geometry.Point(_17,_d.spatialReference);var _19=new esri.Graphic(_17,this._markerSymbol);_e.add(_19);this._anchors.push({graphic:_19,moveable:this._getMoveable(_19,_18)});},this);}},_getBoxCoords:function(_1a){var _1b=this._graphic,map=this._map,_1c=this._getTransformedBoundingBox(_1b),_1d=[],pt,_1e,_1f;_2.forEach(_1c,function(_20,_21,arr){pt=_20;_1e=arr[_21+1];if(!_1e){_1e=arr[0];}_1f={x:(pt.x+_1e.x)/2,y:(pt.y+_1e.y)/2};if(!_1a){pt=map.toMap(pt);_1f=map.toMap(_1f);}_1d.push([pt.x,pt.y]);_1d.push([_1f.x,_1f.y]);});if(this._rotate){var _22=_2.clone(_1d[1]);_22=_1a?{x:_22[0],y:_22[1]}:map.toScreen({x:_22[0],y:_22[1]});_22.y-=this._toolbar._options.rotateHandleOffset;if(!_1a){_22=map.toMap(_22);}_1d.push([_22.x,_22.y]);}return _1d;},_getTransformedBoundingBox:function(_23){var map=this._map;var _24=_23.geometry.getExtent();var _25=new esri.geometry.Point(_24.xmin,_24.ymax);var _26=new esri.geometry.Point(_24.xmax,_24.ymin);_25=map.toScreen(_25);_26=map.toScreen(_26);return [{x:_25.x,y:_25.y},{x:_26.x,y:_25.y},{x:_26.x,y:_26.y},{x:_25.x,y:_26.y}];},_getAllGraphics:function(){var _27=[this._box];if(this._anchors){_2.forEach(this._anchors,function(_28){_27.push(_28.graphic);});}_27=_2.filter(_27,esri._isDefined);return _27;},_getMoveable:function(_29,_2a){var _2b=_29.getDojoShape();if(!_2b){return;}var _2c=new _3.gfx.Moveable(_2b);_2c._index=_2a;this._connects.push(_2.connect(_2c,"onMoveStart",this._moveStartHandler));this._connects.push(_2.connect(_2c,"onFirstMove",this._firstMoveHandler));this._connects.push(_2.connect(_2c,"onMoveStop",this._moveStopHandler));_2c.onMove=this._moveHandler;var _2d=_2b.getEventSource();if(_2d){_2.style(_2d,"cursor",this._toolbar._cursors["box"+_2a]);}return _2c;},_moveStartHandler:function(_2e){this._toolbar["on"+(_2e.host._index===8?this._rotateEvent:this._scaleEvent)+"Start"](this._graphic);},_firstMoveHandler:function(_2f){var _30=_2f.host._index,_31=(this._wrapOffset=_2f.host.shape._wrapOffsets[0]||0),_32=this._graphic.getLayer()._div.getTransform(),mx=_3.gfx.matrix,_33,_34,_35,_36=_2.map(this._getBoxCoords(true),function(arr){return {x:arr[0]+_31,y:arr[1]};});if(_30===8){_33=mx.multiplyPoint(mx.invert(_32),_36[1]);_35={x:_36[1].x,y:_36[3].y};_34=mx.multiplyPoint(mx.invert(_32),_35);this._startLine=[_34,_33];this._moveLine=_2.clone(this._startLine);}else{_33=mx.multiplyPoint(mx.invert(_32),_36[_30]);_34=mx.multiplyPoint(mx.invert(_32),_36[(_30+4)%8]);this._startBox=_34;this._startBox.width=(_36[4].x-_36[0].x);this._startBox.height=(_36[4].y-_36[0].y);this._moveBox=_2.clone(this._startBox);this._xfactor=_33.x>_34.x?1:-1;this._yfactor=_33.y>_34.y?1:-1;if(_30===1||_30===5){this._xfactor=0;}else{if(_30===3||_30===7){this._yfactor=0;}}}this._toolbar._beginOperation("BOX");this._toolbar["on"+(_30===8?this._rotateEvent:this._scaleEvent)+"FirstMove"](this._graphic);},_moveHandler:function(_37,_38){var _39=_37.host._index,_3a=this._defaultEventArgs,_3b,_3c,tx,pt,_3d,_3e,_3f;_3a.angle=0;_3a.scaleX=1;_3a.scaleY=1;if(_39===8){_3b=this._startLine;_3c=this._moveLine;pt=_3c[1];pt.x+=_38.dx;pt.y+=_38.dy;_3d=this._getAngle(_3b,_3c);tx=_3.gfx.matrix.rotategAt(_3d,_3b[0]);this._graphic.getDojoShape().setTransform(tx);_3a.transform=tx;_3a.angle=_3d;_3a.around=_3b[0];}else{_3b=this._startBox;_3c=this._moveBox;_3c.width+=(_38.dx*this._xfactor);_3c.height+=(_38.dy*this._yfactor);_3e=_3c.width/_3b.width;_3f=_3c.height/_3b.height;if(isNaN(_3e)||_3e===Infinity||_3e===-Infinity){_3e=1;}if(isNaN(_3f)||_3f===Infinity||_3f===-Infinity){_3f=1;}tx=_3.gfx.matrix.scaleAt(_3e,_3f,_3b);this._graphic.getDojoShape().setTransform(tx);_3a.transform=tx;_3a.scaleX=_3e;_3a.scaleY=_3f;_3a.around=_3b;}this._toolbar["on"+(_39===8?this._rotateEvent:this._scaleEvent)](this._graphic,_3a);},_moveStopHandler:function(_40){var _41=this._graphic,_42=_41.geometry.toJson(),_43=_41.getDojoShape(),_44=_43.getTransform(),_45=_41.getLayer()._div.getTransform();this._updateSegments(_42.paths||_42.rings,_44,_45);_43.setTransform(null);_41.setGeometry(esri.geometry.fromJson(_42));this._draw();this._startBox=this._moveBox=this._xfactor=this._yfactor=null;this._startLine=this._moveLine=null;this._toolbar._endOperation("BOX");this._defaultEventArgs.transform=_44;this._toolbar["on"+(_40.host._index===8?this._rotateEvent:this._scaleEvent)+"Stop"](this._graphic,this._defaultEventArgs);},_updateSegments:function(_46,_47,_48){var mx=_3.gfx.matrix,map=this._map,_49=this._wrapOffset||0;_2.forEach(_46,function(_4a){_2.forEach(_4a,function(_4b){var _4c=map.toScreen({x:_4b[0],y:_4b[1]},true);_4c.x+=_49;_4c=mx.multiplyPoint([_48,_47,mx.invert(_48)],_4c);_4c.x-=_49;var _4d=map.toMap(_4c);_4b[0]=_4d.x;_4b[1]=_4d.y;});});},_getAngle:function(_4e,_4f){var _50=Math.atan2(_4e[0].y-_4e[1].y,_4e[0].x-_4e[1].x)*180/Math.PI,_51=Math.atan2(_4f[0].y-_4f[1].y,_4f[0].x-_4f[1].x)*180/Math.PI;return _51-_50;}});});