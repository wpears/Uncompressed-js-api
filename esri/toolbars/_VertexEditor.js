/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define(["dijit","dojo","dojox","dojo/require!dijit/Menu,esri/toolbars/_VertexMover"],function(_1,_2,_3){_2.provide("esri.toolbars._VertexEditor");_2.require("dijit.Menu");_2.require("esri.toolbars._VertexMover");_2.declare("esri.toolbars._GraphicVertexEditor",null,{constructor:function(_4,_5,_6){this.graphic=_4;this.map=_5;this.toolbar=_6;var _7=_6._options;this._symbol1=_7.vertexSymbol;this._symbol2=_7.ghostVertexSymbol;var _8=_7.ghostLineSymbol;this._lineStroke={style:_8.style,width:_8.width,color:_8.color};this._canDel=_7.allowDeleteVertices;this._canAdd=_7.allowAddVertices;this._addControllers();},destroy:function(){this._removeControllers();},refresh:function(_9){if(_9){this._removeControllers();this._addControllers();}else{this._refresh(this._vertexMovers);this._refresh(this._mpVertexMovers);}},suspend:function(){if(!this._suspended){this._removeControllers();}this._suspended=true;},resume:function(){if(this._suspended){this._addControllers();}this._suspended=false;},_addControllers:function(){this._firstMoveHandle=_2.connect(esri.toolbars.VertexMover,"onFirstMove",this,this._firstMoveHandler);this._moveStopHandle=_2.connect(esri.toolbars.VertexMover,"onMoveStop",this,this._moveStopHandler);this._vertexMovers=this._add(this._getSegments(this.graphic.geometry),this._symbol1);if(this._canAdd){this._mpVertexMovers=this._add(this._getMidpointSegments(this.graphic.geometry),this._symbol2,true);}var _a=this._getGraphicsLayer();this._mouseOverHandle=_2.connect(_a,"onMouseOver",this,this._mouseOverHandler);this._mouseOutHandle=_2.connect(_a,"onMouseOut",this,this._mouseOutHandler);if(this._canDel){this._ctxMenu=new _1.Menu({style:"font-size: 12px; margin-left: 5px; margin-top: 5px;"});var _b=(this._ctxDelete=new _1.MenuItem({label:esri.bundle.toolbars.edit.deleteLabel,iconClass:"vertexDeleteIcon",style:"outline: none;"}));this._deleteHandle=_2.connect(_b,"onClick",this,this._deleteHandler);this._ctxMenu.addChild(_b);this._ctxMenu.startup();}},_removeControllers:function(){_2.disconnect(this._firstMoveHandle);_2.disconnect(this._moveStopHandle);_2.disconnect(this._mouseOverHandle);_2.disconnect(this._mouseOutHandle);_2.disconnect(this._deleteHandle);if(this._ctxMenu){this._ctxDelete=null;this._unbindCtxNode();this._ctxMenu.destroyRecursive();}this._remove(this._vertexMovers);this._remove(this._mpVertexMovers);this._vertexMovers=this._mpVertexMovers=null;},_add:function(_c,_d,_e){var i,j,_f=this.graphic,_10=[];for(i=0;i<_c.length;i++){var _11=_c[i],_12=[];for(j=0;j<_11.length;j++){_12.push(new esri.toolbars.VertexMover(_11[j],_d,_f,i,j,_11.length,this,_e));}_10.push(_12);}return _10;},_remove:function(_13){if(_13){_2.forEach(_13,function(_14){_2.forEach(_14,function(_15){_15.destroy();});});}},_refresh:function(_16){if(_16){_2.forEach(_16,function(_17){_2.forEach(_17,function(_18){_18.refresh();});});}},_isNew:function(_19){return (_2.indexOf(this._vertexMovers[_19.segIndex],_19)===-1)?true:false;},_getGraphicsLayer:function(){return this.toolbar._scratchGL;},_deleteHandler:function(evt){var _1a=this._selectedMover,_1b=_1a.ptIndex;this._updateRelatedGraphic(_1a,_1a.relatedGraphic,_1a.graphic.geometry,_1a.segIndex,_1a.ptIndex,_1a.segLength,false,true);if(this._canAdd){this._deleteMidpoints(_1a);}this._deleteVertex(_1a);this.toolbar._endOperation("VERTICES");},_mouseOverHandler:function(evt){var _1c=evt.graphic,_1d=this._findMover(_1c);if(_1d){this.toolbar.onVertexMouseOver(this.graphic,_1d._getInfo());if(!_1d._placeholder){this._selectedMover=_1d;if(this._canDel){this._bindCtxNode(_1c.getDojoShape().getNode());}}}},_mouseOutHandler:function(evt){var _1e=evt.graphic,_1f=this._findMover(_1e);if(_1f){this.toolbar.onVertexMouseOut(this.graphic,_1f._getInfo());}},_bindCtxNode:function(_20){this._unbindCtxNode();this._ctxDelete.set("disabled",(this._selectedMover.segLength<=this.minLength)?true:false);this._ctxMenu.bindDomNode(_20);this._bindNode=_20;},_unbindCtxNode:function(){var _21=this._bindNode;if(_21){this._ctxMenu.unBindDomNode(_21);}},_findMover:function(_22){var i,_23=[],_24=this._mpVertexMovers;_2.forEach(this._vertexMovers,function(_25){_23=_23.concat(_25);});if(_24){_2.forEach(_24,function(_26){_23=_23.concat(_26);});}for(i=0;i<_23.length;i++){var _27=_23[i];if(_27.graphic===_22){return _27;}}},_firstMoveHandler:function(_28){if(!this._isNew(_28)&&this._canAdd){this._hideRelatedMidpoints(_28);}this.toolbar._beginOperation("VERTICES");},_moveStopHandler:function(_29,tx){var add=this._isNew(_29);if(!tx||!tx.dx&&!tx.dy){if(!add&&this._canAdd){this._showRelatedMidpoints(_29);}return;}this._updateRelatedGraphic(_29,_29.relatedGraphic,_29.graphic.geometry,_29.segIndex,_29.ptIndex,_29.segLength,add);if(this._canAdd){if(add){this._addMidpoints(_29);}else{this._repositionRelatedMidpoints(_29);this._showRelatedMidpoints(_29);}}this.toolbar._endOperation("VERTICES");},_showRelatedMidpoints:function(_2a){var i,_2b=this._getAdjacentMidpoints(_2a.ptIndex,_2a.segLength),_2c=this._mpVertexMovers[_2a.segIndex];for(i=0;i<_2b.length;i++){var mvr=_2c[_2b[i]];mvr.graphic.show();mvr.refresh();}},_hideRelatedMidpoints:function(_2d){var i,_2e=this._getAdjacentMidpoints(_2d.ptIndex,_2d.segLength),_2f=this._mpVertexMovers[_2d.segIndex];for(i=0;i<_2e.length;i++){_2f[_2e[i]].graphic.hide();}},_repositionRelatedMidpoints:function(_30){var i,_31=this._getAdjacentMidpoints(_30.ptIndex,_30.segLength),_32=this._mpVertexMovers[_30.segIndex];for(i=0;i<_31.length;i++){var _33=this._getAdjacentVertices(_31[i],_30.segLength);var _34=_30.relatedGraphic.geometry.getPoint(_30.segIndex,_33[0]),_35=_30.relatedGraphic.geometry.getPoint(_30.segIndex,_33[1]);var _36=new esri.geometry.Point({x:(_34.x+_35.x)/2,y:(_34.y+_35.y)/2,spatialReference:_34.spatialReference.toJson()});_32[_31[i]].graphic.setGeometry(_36);}},_addMidpoints:function(_37){var _38=_37.segIndex,_39=_37.ptIndex,_3a=_37.segLength;var _3b=_39+1;var i,_3c=_3a+1;this._mpVertexMovers[_38].splice(_39,1);var _3d=this._vertexMovers[_38];for(i=0;i<_3b;i++){_3d[i].segLength+=1;}for(i=_3b;i<_3d.length;i++){_3d[i].ptIndex+=1;_3d[i].segLength+=1;}_37.ptIndex=_3b;_37.segLength=_3d.length+1;_3d.splice(_3b,0,_37);_37.graphic.setSymbol(this._symbol1);_3d=this._mpVertexMovers[_38];for(i=0;i<_39;i++){_3d[i].segLength+=1;}for(i=_39;i<_3a-1;i++){_3d[i].ptIndex+=1;_3d[i].segLength+=1;}var _3e=this._getAdjacentVertices(_39,_3c);var _3f=this._getAdjacentVertices(_39+1,_3c);var _40,_41;_40=_37.relatedGraphic.geometry.getPoint(_37.segIndex,_3e[0]);_41=_37.relatedGraphic.geometry.getPoint(_37.segIndex,_3e[1]);var _42=new esri.geometry.Point({x:(_40.x+_41.x)/2,y:(_40.y+_41.y)/2,spatialReference:_40.spatialReference.toJson()});_40=_37.relatedGraphic.geometry.getPoint(_37.segIndex,_3f[0]);_41=_37.relatedGraphic.geometry.getPoint(_37.segIndex,_3f[1]);var _43=new esri.geometry.Point({x:(_40.x+_41.x)/2,y:(_40.y+_41.y)/2,spatialReference:_40.spatialReference.toJson()});var _44=new esri.toolbars.VertexMover(_42,this._symbol2,this.graphic,_37.segIndex,_39,_3c,this,true);var _45=new esri.toolbars.VertexMover(_43,this._symbol2,this.graphic,_37.segIndex,_39+1,_3c,this,true);_3d.splice(_39,0,_44,_45);},_deleteVertex:function(_46){var i,_47=_46.segIndex,_48=_46.ptIndex;var _49=this._vertexMovers[_47];for(i=0;i<_48;i++){_49[i].segLength-=1;}for(i=_48+1;i<_49.length;i++){var mvr=_49[i];mvr.ptIndex-=1;mvr.segLength-=1;}_49.splice(_48,1);var _4a=_46._getInfo();_46.destroy();this.toolbar.onVertexDelete(this.graphic,_4a);}});_2.mixin(esri.toolbars._GraphicVertexEditor,{create:function(_4b,map,_4c){var _4d=_4b.geometry.type;switch(_4d){case "multipoint":return new esri.toolbars._MultipointVertexEditor(_4b,map,_4c);break;case "polyline":return new esri.toolbars._PolylineVertexEditor(_4b,map,_4c);break;case "polygon":return new esri.toolbars._PolygonVertexEditor(_4b,map,_4c);break;}}});_2.declare("esri.toolbars._MultipointVertexEditor",esri.toolbars._GraphicVertexEditor,{minLength:1,constructor:function(){this._moveStartHandle=_2.connect(esri.toolbars.VertexMover,"onMoveStart",this,this._moveStartHandler);_2.disconnect(this._firstMoveHandle);},destroy:function(){this.inherited(arguments);_2.disconnect(this._moveStartHandle);},_getSegments:function(_4e){var i,_4f=_4e.points,_50=[],sr=_4e.spatialReference;for(i=0;i<_4f.length;i++){var _51=_4f[i];_50.push(new esri.geometry.Point({x:_51[0],y:_51[1],spatialReference:sr.toJson()}));}return [_50];},_getMidpointSegments:function(_52){return [];},_getControlPoints:function(_53,_54,_55,_56,_57){return [];},_getGraphicsLayer:function(){return this.graphic._graphicsLayer;},_mouseOverHandler:function(evt){var _58=evt.graphic,_59=this._findMover(evt);if(_59){this.toolbar.onVertexMouseOver(_58,_59._getInfo());this._selectedMover=_59;if(this._canDel){this._bindCtxNode(_59.graphic.getDojoShape().getNode());}}},_mouseOutHandler:function(evt){var _5a=evt.graphic,_5b=this._findMover(evt);if(_5b){this.toolbar.onVertexMouseOut(_5a,_5b._getInfo());}},_findMover:function(evt){var i,_5c=[].concat(this._vertexMovers[0]),_5d=evt.target;for(i=0;i<_5c.length;i++){var _5e=_5c[i];if(_5e.graphic.getDojoShape().getNode()===_5d){return _5e;}}},_moveStartHandler:function(_5f){var _60=_5f.relatedGraphic.geometry,_61=_5f.ptIndex;var _62=_5f.segLength-1;var _63=_60.points;var _64=_63.splice(_61,1);_63.push(_64[0]);var j,_65=this._vertexMovers[0];for(j=_62;j>_61;j--){_65[j].ptIndex-=1;}_64=_65.splice(_61,1);_65.push(_64[0]);_64[0].ptIndex=_62;},_moveStopHandler:function(_66){this._updateRelatedGraphic(_66,_66.relatedGraphic,_66.graphic.geometry,_66.segIndex,_66.ptIndex,_66.segLength);this.toolbar._endOperation("VERTICES");},_updateRelatedGraphic:function(_67,_68,_69,_6a,_6b,_6c,add,del){var _6d=_68.geometry;if(del){_6d.removePoint(_6b);}else{_6d.setPoint(_6b,_69);}_68.setGeometry(_6d);},_deleteMidpoints:function(_6e){}});_2.declare("esri.toolbars._PolylineVertexEditor",esri.toolbars._GraphicVertexEditor,{minLength:2,_getSegments:function(_6f){var i,j,_70=_6f.paths,_71=[];for(i=0;i<_70.length;i++){var _72=_70[i],_73=[];for(j=0;j<_72.length;j++){_73.push(_6f.getPoint(i,j));}_71.push(_73);}return _71;},_getMidpointSegments:function(_74){var i,j,_75=_74.paths,_76=[],sr=_74.spatialReference;for(i=0;i<_75.length;i++){var _77=_75[i],_78=[];for(j=0;j<_77.length-1;j++){var _79=_74.getPoint(i,j),_7a=_74.getPoint(i,j+1);var _7b=(_79.x+_7a.x)/2,_7c=(_79.y+_7a.y)/2;var _7d=new esri.geometry.Point({x:_7b,y:_7c,spatialReference:sr.toJson()});_78.push(_7d);}_76.push(_78);}return _76;},_getControlPoints:function(_7e,_7f,_80,_81,_82){var map=this.map,_83,_84,pt1,pt2;if(this._isNew(_7e)){_83=_81;_84=_81+1;if(_83>=0){pt1=map.toScreen(_7f.getPoint(_80,_83));}if(_84<=_82){pt2=map.toScreen(_7f.getPoint(_80,_84));}}else{_83=_81-1;_84=_81+1;if(_83>=0){pt1=map.toScreen(_7f.getPoint(_80,_83));}if(_84<_82){pt2=map.toScreen(_7f.getPoint(_80,_84));}}return [pt1,pt2];},_getAdjacentMidpoints:function(_85,_86){var _87=[];var _88=_85-1;if(_88>=0){_87.push(_88);}var _89=_85;if(_89<_86-1){_87.push(_89);}return _87;},_getAdjacentVertices:function(_8a,_8b){return [_8a,_8a+1];},_deleteMidpoints:function(_8c){var _8d=_8c.segIndex,_8e=_8c.ptIndex,_8f=_8c.segLength;var _90=this._mpVertexMovers[_8d],_91=_90.length-1;var _92=this._getAdjacentMidpoints(_8e,_8f).sort();var i,min=_92[0];for(i=0;i<min;i++){_90[i].segLength-=1;}for(i=min+1;i<_90.length;i++){var mvr=_90[i];mvr.ptIndex-=1;mvr.segLength-=1;}if(_92.length===1){_90.splice(min,1)[0].destroy();}else{var _93=this._getAdjacentVertices(min,_91);var _94=_8c.relatedGraphic.geometry.getPoint(_8c.segIndex,_93[0]);var _95=_8c.relatedGraphic.geometry.getPoint(_8c.segIndex,_93[1]);var _96=new esri.geometry.Point({x:(_94.x+_95.x)/2,y:(_94.y+_95.y)/2,spatialReference:_94.spatialReference.toJson()});var _97=new esri.toolbars.VertexMover(_96,this._symbol2,this.graphic,_8c.segIndex,min,_91,this,true);var _98=_90.splice(min,_92.length,_97);for(i=0;i<_98.length;i++){_98[i].destroy();}}},_updateRelatedGraphic:function(_99,_9a,_9b,_9c,_9d,_9e,add,del){var _9f=_9a.geometry;if(add){_9f.insertPoint(_9c,_9d+1,esri.geometry.fromJson(_9b.toJson()));}else{if(del){_9f.removePoint(_9c,_9d);}else{_9f.setPoint(_9c,_9d,esri.geometry.fromJson(_9b.toJson()));}}_9a.setGeometry(_9f);}});_2.declare("esri.toolbars._PolygonVertexEditor",esri.toolbars._GraphicVertexEditor,{minLength:3,_getSegments:function(_a0){var i,j,_a1=_a0.rings,_a2=[];for(i=0;i<_a1.length;i++){var _a3=_a1[i],_a4=[];for(j=0;j<_a3.length-1;j++){_a4.push(_a0.getPoint(i,j));}_a2.push(_a4);}return _a2;},_getMidpointSegments:function(_a5){var i,j,_a6=_a5.rings,_a7=[],sr=_a5.spatialReference;for(i=0;i<_a6.length;i++){var _a8=_a6[i],_a9=[];for(j=0;j<_a8.length-1;j++){var _aa=_a5.getPoint(i,j),_ab=_a5.getPoint(i,j+1);var _ac=(_aa.x+_ab.x)/2,_ad=(_aa.y+_ab.y)/2;var _ae=new esri.geometry.Point({x:_ac,y:_ad,spatialReference:sr.toJson()});_a9.push(_ae);}_a7.push(_a9);}return _a7;},_getControlPoints:function(_af,_b0,_b1,_b2,_b3){var map=this.map,_b4,_b5,pt1,pt2;if(this._isNew(_af)){_b4=_b2;_b5=(_b2+1)%_b3;}else{_b4=_b2-1;_b4=_b4<0?(_b3+_b4)%_b3:_b4;_b5=(_b2+1)%_b3;}pt1=map.toScreen(_b0.getPoint(_b1,_b4));pt2=map.toScreen(_b0.getPoint(_b1,_b5));return [pt1,pt2];},_getAdjacentMidpoints:function(_b6,_b7){var _b8=_b6-1;_b8=_b8<0?(_b7+_b8)%_b7:_b8;var _b9=_b6;return [_b8,_b9];},_getAdjacentVertices:function(_ba,_bb){return [_ba,(_ba+1)%_bb];},_deleteMidpoints:function(_bc){var _bd=_bc.segIndex,_be=_bc.ptIndex,_bf=_bc.segLength;var _c0=this._mpVertexMovers[_bd],_c1=_c0.length-1,_c2=this._getAdjacentMidpoints(_be,_bf).sort(),_c3,_c4,_c5,_c6,i,_c7,mvr,min=_c2[0],max=_c2[_c2.length-1];if(_be===0){_c3=this._getAdjacentVertices(_c1-1,_c1);_c4=_bc.relatedGraphic.geometry.getPoint(_bc.segIndex,_c3[0]);_c5=_bc.relatedGraphic.geometry.getPoint(_bc.segIndex,_c3[1]);_c6=new esri.geometry.Point({x:(_c4.x+_c5.x)/2,y:(_c4.y+_c5.y)/2,spatialReference:_c4.spatialReference.toJson()});_c7=new esri.toolbars.VertexMover(_c6,this._symbol2,this.graphic,_bc.segIndex,_c1-1,_c1,this,true);_c0.splice(max,1,_c7)[0].destroy();_c0.splice(min,1)[0].destroy();for(i=0;i<_c0.length-1;i++){mvr=_c0[i];mvr.ptIndex-=1;mvr.segLength-=1;}}else{_c3=this._getAdjacentVertices(min,_c1);_c4=_bc.relatedGraphic.geometry.getPoint(_bc.segIndex,_c3[0]);_c5=_bc.relatedGraphic.geometry.getPoint(_bc.segIndex,_c3[1]);_c6=new esri.geometry.Point({x:(_c4.x+_c5.x)/2,y:(_c4.y+_c5.y)/2,spatialReference:_c4.spatialReference.toJson()});_c7=new esri.toolbars.VertexMover(_c6,this._symbol2,this.graphic,_bc.segIndex,min,_c1,this,true);var _c8=_c0.splice(min,_c2.length,_c7);for(i=0;i<_c8.length;i++){_c8[i].destroy();}for(i=0;i<min;i++){_c0[i].segLength-=1;}for(i=min+1;i<_c0.length;i++){mvr=_c0[i];mvr.ptIndex-=1;mvr.segLength-=1;}}},_updateRelatedGraphic:function(_c9,_ca,_cb,_cc,_cd,_ce,add,del){var _cf=_ca.geometry;if(add){_cf.insertPoint(_cc,_cd+1,esri.geometry.fromJson(_cb.toJson()));}else{if(del){_cf.removePoint(_cc,_cd);if(_cd===0){_cf.setPoint(_cc,_ce-1,esri.geometry.fromJson(_cf.getPoint(_cc,0).toJson()));}}else{_cf.setPoint(_cc,_cd,esri.geometry.fromJson(_cb.toJson()));if(_cd===0){_cf.setPoint(_cc,_ce,esri.geometry.fromJson(_cb.toJson()));}}}_ca.setGeometry(_cf);}});});