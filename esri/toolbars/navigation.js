/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define(["dijit","dojo","dojox","dojo/require!esri/toolbars/_toolbar,esri/geometry,esri/symbol,esri/utils,esri/undoManager"],function(_1,_2,_3){_2.provide("esri.toolbars.navigation");_2.require("esri.toolbars._toolbar");_2.require("esri.geometry");_2.require("esri.symbol");_2.require("esri.utils");_2.require("esri.undoManager");_2.declare("esri.toolbars.MapExtent",esri.OperationBase,{label:"extent changes",constructor:function(_4){this.map=_4.map;this.preExtent=_4.preExtent;this.currentExtent=_4.currentExtent;},performRedo:function(){this.map.setExtent(this.currentExtent);},performUndo:function(){this.map.setExtent(this.preExtent);}});_2.declare("esri.toolbars.Navigation",esri.toolbars._Toolbar,{constructor:function(_5){this.zoomSymbol=new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new _2.Color([255,0,0]),2),new _2.Color([0,0,0,0.25]));_2.connect(_5,"onUnload",this,"_cleanUp");this.map=_5;this._undoManager=new esri.UndoManager({maxOperations:-1});this._normalizeRect=_2.hitch(this,this._normalizeRect);this._onMouseDownHandler=_2.hitch(this,this._onMouseDownHandler);this._onMouseUpHandler=_2.hitch(this,this._onMouseUpHandler);this._onMouseDragHandler=_2.hitch(this,this._onMouseDragHandler);this._onExtentChangeHandler_connect=_2.connect(_5,"onExtentChange",this,"_extentChangeHandler");this._onMapLoad_connect=_2.connect(_5,"onLoad",this,"_mapOnLoandHandler");if(_5.loaded&&_5.extent){this._currentExtent=_5.extent;}},_mapOnLoandHandler:function(){this._currentExtent=this.map.extent;},_navType:null,_start:null,_graphic:null,_prevExtent:false,_currentExtent:null,_preExtent:null,_cleanUp:function(_6){_2.disconnect(this._onExtentChangeHandler_connect);_2.disconnect(this._onMapLoad_connect);},activate:function(_7){var _8=this.map;if(!this._graphic){this._deactivateMapTools(true,false,false,true);this._graphic=new esri.Graphic(null,this.zoomSymbol);}switch(_7){case esri.toolbars.Navigation.ZOOM_IN:case esri.toolbars.Navigation.ZOOM_OUT:this._deactivate();this._onMouseDownHandler_connect=_2.connect(_8,"onMouseDown",this,"_onMouseDownHandler");this._onMouseDragHandler_connect=_2.connect(_8,"onMouseDrag",this,"_onMouseDragHandler");this._onMouseUpHandler_connect=_2.connect(_8,"onMouseUp",this,"_onMouseUpHandler");this._navType=_7;break;case esri.toolbars.Navigation.PAN:this._deactivate();_8.enablePan();this._navType=_7;break;}},_extentChangeHandler:function(_9){if(this._prevExtent||this._nextExtent){this._currentExtent=_9;}else{this._preExtent=this._currentExtent;this._currentExtent=_9;if(this._preExtent&&this._currentExtent){var _a=esri.toolbars.MapExtent({map:this.map,preExtent:this._preExtent,currentExtent:this._currentExtent});this._undoManager.add(_a);}}this._prevExtent=this._nextExtent=false;this.onExtentHistoryChange();},_deactivate:function(){var _b=this._navType;if(_b===esri.toolbars.Navigation.PAN){this.map.disablePan();}else{if(_b===esri.toolbars.Navigation.ZOOM_IN||_b===esri.toolbars.Navigation.ZOOM_OUT){_2.disconnect(this._onMouseDownHandler_connect);_2.disconnect(this._onMouseDragHandler_connect);_2.disconnect(this._onMouseUpHandler_connect);}}},_normalizeRect:function(_c,_d,_e){var sx=_c.x,sy=_c.y,ex=_d.x,ey=_d.y,_f=Math.abs(sx-ex),_10=Math.abs(sy-ey);return {x:Math.min(sx,ex),y:Math.max(sy,ey),width:_f,height:_10,spatialReference:_e};},_onMouseDownHandler:function(evt){this._start=evt.mapPoint;},_onMouseDragHandler:function(evt){var _11=this._graphic,_12=this.map.graphics;_12.remove(_11,true);_11.setGeometry(new esri.geometry.Rect(this._normalizeRect(this._start,evt.mapPoint,this.map.spatialReference)));_12.add(_11,true);},_onMouseUpHandler:function(evt){var map=this.map,_13=this._normalizeRect(this._start,evt.mapPoint,map.spatialReference);map.graphics.remove(this._graphic,true);if(_13.width===0&&_13.height===0){return;}if(this._navType===esri.toolbars.Navigation.ZOOM_IN){map.setExtent(esri.geometry._rectToExtent(new esri.geometry.Rect(_13)));}else{var tl=map.toScreen(_13),tr=map.toScreen({x:_13.x+_13.width,y:_13.y,spatialReference:map.spatialReference}),_14=map.extent.getWidth(),_15=(_14*map.width)/Math.abs(tr.x-tl.x),_16=(_15-_14)/2,ext=map.extent;map.setExtent(new esri.geometry.Extent(ext.xmin-_16,ext.ymin-_16,ext.xmax+_16,ext.ymax+_16,ext.spatialReference));}},deactivate:function(){this._deactivate();if(this._graphic){this.map.graphics.remove(this._graphic,true);}this._navType=this._start=this._graphic=null;this._activateMapTools(true,false,false,true);},setZoomSymbol:function(_17){this.zoomSymbol=_17;},isFirstExtent:function(){return !this._undoManager.canUndo;},isLastExtent:function(){return !this._undoManager.canRedo;},zoomToFullExtent:function(){var map=this.map;map.setExtent(map.getLayer(map.layerIds[0]).initialExtent);},zoomToPrevExtent:function(){if(!this._undoManager.canUndo){return;}this._prevExtent=true;this._undoManager.undo();},zoomToNextExtent:function(){if(!this._undoManager.canRedo){return;}this._nextExtent=true;this._undoManager.redo();},onExtentHistoryChange:function(){}});_2.mixin(esri.toolbars.Navigation,{ZOOM_IN:"zoomin",ZOOM_OUT:"zoomout",PAN:"pan"});});