/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define(["dijit","dojo","dojox","dojo/require!dijit/_Widget,dijit/_Templated,dojox/form/RangeSlider,dijit/form/HorizontalRuleLabels,dijit/form/HorizontalRule,dojox/timing/_base"],function(_1,_2,_3){_2.provide("esri.dijit.TimeSlider");_2.require("dijit._Widget");_2.require("dijit._Templated");_2.require("dojox.form.RangeSlider");_2.require("dijit.form.HorizontalRuleLabels");_2.require("dijit.form.HorizontalRule");_2.require("dojox.timing._base");(function(){var _4=[_2.moduleUrl("dojox","form/resources/RangeSlider.css"),_2.moduleUrl("esri.dijit","css/TimeSlider.css")];var _5=document.getElementsByTagName("head").item(0),_6;for(var i=0,il=_4.length;i<il;i++){_6=document.createElement("link");_6.type="text/css";_6.rel="stylesheet";_6.href=_4[i];_5.appendChild(_6);}})();_2.declare("esri.dijit.TimeSlider",[_1._Widget,_1._Templated],{widgetsInTemplate:true,templateString:"   <div class=\"esriTimeSlider\">\r\n   <table width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\">\r\n   <tr>\r\n   <td align=\"right\" valign=\"middle\"><button dojoType=\"dijit.form.Button\" showLabel=\"false\" iconClass=\"tsButton tsPlayButton\" dojoAttachEvent=\"onClick:_onPlay\" dojoAttachPoint=\"playPauseBtn\" type=\"button\">${NLS_play}</button></td>\r\n   <td align=\"center\" valign=\"middle\" width=\"80%\" id=\"tsTmp\"></td>\r\n   <td align=\"left\" valign=\"middle\" width=\"30\"><button dojoType=\"dijit.form.Button\" showLabel=\"false\" iconClass=\"tsButton tsPrevButton\" dojoAttachEvent=\"onClick:_onPrev\" dojoAttachPoint=\"previousBtn\" type=\"button\">${NLS_previous}</button></td>\r\n   <td align=\"left\" valign=\"middle\"><button dojoType=\"dijit.form.Button\" showLabel=\"false\" iconClass=\"tsButton tsNextButton\" dojoAttachEvent=\"onClick:_onNext\" dojoAttachPoint=\"nextBtn\" type=\"button\">${NLS_next}</button></td>\r\n   </tr>    \r\n   </table>\r\n   </div>",basePath:_2.moduleUrl("esri.dijit"),_slideDuration:1000,_defaultCount:10,constructor:function(_7,_8){_2.mixin(this,esri.bundle.widgets.timeSlider);this._iconClass="tsButton tsPlayButton";this.playing=false;this.loop=false;this.thumbCount=1;this.thumbMovingRate=1000;this._createTimeInstants=false;this._options=_2.mixin({excludeDataAtTrailingThumb:false,excludeDataAtLeadingThumb:false},_7.options||{});},startup:function(){this.inherited(arguments);this._timer=new _3.timing.Timer();this._timer.setInterval(this.thumbMovingRate);this._timer.onTick=_2.hitch(this,"_bumpSlider",1);this._createSlider();},destroy:function(){this._timer.stop();this._timer=null;this.timeStops=null;this._slider.destroy();this._slider=null;if(this._hTicks){this._hTicks.destroyRecursive();this._hTicks=null;}if(this._hLabels){this._hLabels.destroyRecursive();this._hLabels=null;}this.inherited(arguments);},onTimeExtentChange:function(){},onPlay:function(){},onPause:function(){},onNext:function(){},onPrevious:function(){},_onHorizontalChange:function(){var _9=this._sliderToTimeExtent();this.onTimeExtentChange(_9);},_onPlay:function(){this.playing=!this.playing;this._updateUI();if(this.playing){this._timer.start();this.onPlay(this._sliderToTimeExtent());}else{this._timer.stop();this.onPause(this._sliderToTimeExtent());}var _a=this._getSliderValue();this._offset=_2.isArray(_a)?(_a[1]-_a[0]):0;},_onNext:function(){if(!this.playing){this._bumpSlider(1);this.onNext(this._sliderToTimeExtent());}},_onPrev:function(){if(!this.playing){this._bumpSlider(-1);this.onPrevious(this._sliderToTimeExtent());}},createTimeStopsByCount:function(_b,_c){if(!_b||!_b.startTime||!_b.endTime){console.log(this.NLS_invalidTimeExtent);return;}_c=_c||this._defaultCount;var _d=Math.ceil((_b.endTime-_b.startTime)/(_c-1));this.createTimeStopsByTimeInterval(_b,_d,"esriTimeUnitsMilliseconds");},createTimeStopsByTimeInterval:function(_e,_f,_10,_11){if(!_e||!_e.startTime||!_e.endTime){console.log(this.NLS_invalidTimeExtent);return;}this.fullTimeExtent=new esri.TimeExtent(_e.startTime,_e.endTime);if(_11&&_11.resetStartTime===true){this._resetStartTime(this.fullTimeExtent,_10);}this._timeIntervalUnits=_10;var te=this.fullTimeExtent.startTime;var _12=[];while(te<=_e.endTime){_12.push(te);te=_e._getOffsettedDate(te,_f,_10);}if(_12.length>0&&_12[_12.length-1]<_e.endTime){_12.push(te);}this.setTimeStops(_12);},getCurrentTimeExtent:function(){return this._sliderToTimeExtent();},setTimeStops:function(_13){this.timeStops=_13||[];this._numStops=this.timeStops.length;this._numTicks=this._numStops;if(esri._isDefined(this.fullTimeExtent)===false){this.fullTimeExtent=new esri.TimeExtent(_13[0],_13[_13.length-1]);}},setLoop:function(_14){this.loop=_14;},setThumbCount:function(_15){this.thumbCount=_15;this.singleThumbAsTimeInstant(this._createTimeInstants);if(this._slider){this._createSlider();}},setThumbIndexes:function(_16){this.thumbIndexes=_2.clone(_16)||[0,1];this._initializeThumbs();},setThumbMovingRate:function(_17){this.thumbMovingRate=_17;if(this._timer){this._timer.setInterval(this.thumbMovingRate);}},setLabels:function(_18){this.labels=_18;if(this._slider){this._createSlider();}},setTickCount:function(_19){this._numTicks=_19;if(this._slider){this._createSlider();}},singleThumbAsTimeInstant:function(_1a){this._createTimeInstants=(_1a&&this.thumbCount===1);},next:function(){this._onNext();},pause:function(){this.playing=false;this._updateUI();this._timer.stop();},play:function(){if(this.playing===true){return;}this.playing=false;this._onPlay();},previous:function(){this._onPrev();},_updateUI:function(){_2.removeClass(this.playPauseBtn.iconNode,this._iconClass);this._iconClass=this.playing?"tsButton tsPauseButton":"tsButton tsPlayButton";_2.addClass(this.playPauseBtn.iconNode,this._iconClass);this.previousBtn.set("disabled",this.playing);this.nextBtn.set("disabled",this.playing);},_createSlider:function(){if(this._slider){this._slider.destroy();this._slider=null;}var _1b=this.domNode;while(_1b.parentNode&&!_1b.dir){_1b=_1b.parentNode;}var _1c={onChange:_2.hitch(this,"_onHorizontalChange"),showButtons:false,discreteValues:this._numStops,slideDuration:this._slideDuration,"class":"ts",id:"ts",dir:_1b.dir};var ts=_2.create("div",{id:"ts"},_2.byId("tsTmp"),"first");_2.create("div",{id:"timeSliderTicks"},ts,"first");_2.create("div",{id:"timeSliderLabels"},ts);if(this.thumbCount===2){this._createRangeSlider(_1c);}else{this._createSingleSlider(_1c);}this.thumbIndexes=this.thumbIndexes||[0,1];this._createHorizRule();this._createLabels();if(this._createTimeInstants===true){_2.query(".dijitSliderProgressBarH, .dijitSliderLeftBumper, .dijitSliderRightBumper").forEach("dojo.style(item, { background: 'none' });");}this._initializeThumbs();_2.disconnect(this._onChangeConnect);this._onChangeConnect=_2.connect(this._slider,"onChange",_2.hitch(this,"_updateThumbIndexes"));},_createRangeSlider:function(_1d){this._isRangeSlider=true;this._slider=new _3.form.HorizontalRangeSlider(_1d,_2.byId("ts"));},_createSingleSlider:function(_1e){this._isRangeSlider=false;this._slider=new _1.form.HorizontalSlider(_1e,_2.byId("ts"));},_createHorizRule:function(){if(this._hTicks){this._hTicks.destroyRecursive();this._hTicks=null;}if(this._numTicks<2){return;}this._hTicks=new _1.form.HorizontalRule({container:"topDecoration",ruleStyle:"","class":"tsTicks",count:this._numTicks,id:"tsTicks"},_2.byId("timeSliderTicks"));},_createLabels:function(){if(this._hLabels){this._hLabels.destroyRecursive();this._hLabels=null;}if(this.labels&&this.labels.length>0){this._hLabels=new _1.form.HorizontalRuleLabels({labels:this.labels,labelStyle:"","class":"tsLabels",id:"tsLabels"},_2.byId("timeSliderLabels"));}},_initializeThumbs:function(){if(!this._slider){return;}this._offset=this._toSliderValue(this.thumbIndexes[1])||0;var t1=this._toSliderValue(this.thumbIndexes[0]);t1=(t1>this._slider.maximum||t1<this._slider.minimum)?this._slider.minimum:t1;if(this._isRangeSlider===true){var t2=this._toSliderValue(this.thumbIndexes[1]);t2=(t2>this._slider.maximum||t2<this._slider.minimum)?this._slider.maximum:t2;t2=t2<t1?t1:t2;this._setSliderValue([t1,t2]);}else{this._setSliderValue(t1);}this._onHorizontalChange();},_bumpSlider:function(dir){var val=this._getSliderValue();var max=val,min=max;var _1f=dir;if(_2.isArray(val)){min=val[0];max=val[1];_1f=[{"change":dir,"useMaxValue":true},{"change":dir,"useMaxValue":false}];}if((Math.abs(min-this._slider.minimum)<1e-10&&dir<0)||(Math.abs(max-this._slider.maximum)<1e-10&&dir>0)){if(this._timer.isRunning){if(this.loop){this._timer.stop();this._setSliderValue(this._getSliderMinValue());var _20=this._sliderToTimeExtent();this.onTimeExtentChange(_20);this._timer.start();this.playing=true;}else{this.pause();}}}else{this._slider._bumpValue(_1f);}},_updateThumbIndexes:function(){var val=this._getSliderValue();if(_2.isArray(val)){this.thumbIndexes[0]=this._toSliderIndex(val[0]);this.thumbIndexes[1]=this._toSliderIndex(val[1]);}else{this.thumbIndexes[0]=this._toSliderIndex(val);}},_sliderToTimeExtent:function(){if(!this.timeStops||this.timeStops.length===0){return;}var _21=new esri.TimeExtent();var val=this._getSliderValue();if(_2.isArray(val)){_21.startTime=new Date(this.timeStops[this._toSliderIndex(val[0])]);_21.endTime=new Date(this.timeStops[this._toSliderIndex(val[1])]);this._adjustTimeExtent(_21);}else{_21.startTime=(this._createTimeInstants===true)?new Date(this.timeStops[this._toSliderIndex(val)]):new Date(this.fullTimeExtent.startTime);_21.endTime=(this._createTimeInstants===true)?_21.startTime:new Date(this.timeStops[this._toSliderIndex(val)]);}return _21;},_adjustTimeExtent:function(_22){if(this._options.excludeDataAtTrailingThumb===false&&this._options.excludeDataAtLeadingThumb===false){return;}if(_22.startTime.getTime()===_22.endTime.getTime()){return;}if(this._options.excludeDataAtTrailingThumb){var _23=_22.startTime;_23.setUTCSeconds(_23.getUTCSeconds()+1);}if(this._options.excludeDataAtLeadingThumb){var _24=_22.endTime;_24.setUTCSeconds(_24.getUTCSeconds()-1);}},_resetStartTime:function(_25,_26){switch(_26){case "esriTimeUnitsSeconds":_25.startTime.setUTCMilliseconds(0);break;case "esriTimeUnitsMinutes":_25.startTime.setUTCSeconds(0,0,0);break;case "esriTimeUnitsHours":_25.startTime.setUTCMinutes(0,0,0);break;case "esriTimeUnitsDays":_25.startTime.setUTCHours(0,0,0,0);break;case "esriTimeUnitsWeeks":_25.startTime.setUTCDate(_25.startTime.getUTCDate()-_25.startTime.getUTCDay());break;case "esriTimeUnitsMonths":_25.startTime.setUTCDate(1);_25.startTime.setUTCHours(0,0,0,0);break;case "esriTimeUnitsDecades":_25.startTime.setUTCFullYear(_25.startTime.getUTCFullYear()-(_25.startTime.getUTCFullYear()%10));break;case "esriTimeUnitsCenturies":_25.startTime.setUTCFullYear(_25.startTime.getUTCFullYear()-(_25.startTime.getUTCFullYear()%100));break;}},_getSliderMinValue:function(){if(this._isRangeSlider){return [this._slider.minimum,this._slider.minimum+this._offset];}else{return this._slider.minimum;}},_toSliderIndex:function(val){var idx=Math.floor((val-this._slider.minimum)*this._numStops/(this._slider.maximum-this._slider.minimum));if(idx<0){idx=0;}if(idx>=this._numStops){idx=this._numStops-1;}return idx;},_toSliderValue:function(val){return val*(this._slider.maximum-this._slider.minimum)/(this._numStops-1)+this._slider.minimum;},_getSliderValue:function(){return this._slider.get("value");},_setSliderValue:function(val){this._slider._setValueAttr(val,false,false);}});});