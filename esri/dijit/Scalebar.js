/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define(["dijit","dojo","dojox","dojo/require!esri/geometry,esri/map,esri/WKIDUnitConversion"],function(_1,_2,_3){_2.provide("esri.dijit.Scalebar");_2.require("esri.geometry");_2.require("esri.map");_2.require("esri.WKIDUnitConversion");(function(){var _4=[_2.moduleUrl("esri.dijit","css/Scalebar.css")];var _5=document.getElementsByTagName("head").item(0),_6;for(var i=0,il=_4.length;i<il;i++){_6=document.createElement("link");_6.type="text/css";_6.rel="stylesheet";_6.href=_4[i].toString();_5.appendChild(_6);}}());_2.declare("esri.dijit.Scalebar",null,{map:null,mapUnit:null,scalebarUnit:null,unitsDictionary:[],domNode:null,screenPt1:null,screenPt2:null,constructor:function(_7,_8){this.domNode=_2.create("div",{innerHTML:"<div class='esriScalebarRuler'><div class='esriScalebarRulerBlock upper_firstpiece'></div><div class='esriScalebarRulerBlock upper_secondpiece'></div><div class='esriScalebarRulerBlock lower_firstpiece'></div><div class='esriScalebarRulerBlock lower_secondpiece'></div></div><div class='scaleLabelDiv'><div class='esriScalebarLabel' style='left: -3%'>0</div><div class='esriScalebarLabel esriScalebarFirstNumber'></div><div class='esriScalebarLabel esriScalebarSecondNumber'></div></div>"});_7=_7||{};if(!_7.map){console.error("scalebar: unable to find the 'map' property in parameters");return;}if(!_7.scalebarUnit){this.scalebarUnit="mi";}else{if(_7.scalebarUnit!=="english"&&_7.scalebarUnit!=="metric"){console.error("scalebar unit only accepts english or metric");return;}else{this.scalebarUnit=(_7.scalebarUnit==="english")?"mi":"km";}}this.map=_7.map;if(_8){_8.appendChild(this.domNode);}else{this.map.container.appendChild(this.domNode);if(_7.attachTo){_2.addClass(this.domNode,"scalebar_"+_7.attachTo);}else{_2.addClass(this.domNode,"scalebar_bottom-left");}}_2.addClass(this.domNode,"esriScalebar");this._getDistance(this.map.extent);this._checkBingMaps();this._mapOnPan=_2.connect(this.map,"onPan",this,this._getDistance);this._mapOnExtentChange=_2.connect(this.map,"onExtentChange",this,this._getDistance);_2.forEach(this.map.layerIds,function(_9,_a){if(this.map.getLayer(_9).declaredClass==="esri.virtualearth.VETiledLayer"){_2.connect(this.map.getLayer(_9),"onVisibilityChange",_2.hitch(this,function(_b){this._checkBingMaps();}));}},this);this._mapOnLayerAdd=_2.connect(this.map,"onLayerAdd",_2.hitch(this,function(_c){if(_c.declaredClass==="esri.virtualearth.VETiledLayer"){_2.connect(_c,"onVisibilityChange",_2.hitch(this,function(_d){this._checkBingMaps();}));}this._checkBingMaps();}));this._mapOnLayerRemove=_2.connect(this.map,"onLayerRemove",_2.hitch(this,this._checkBingMaps));},hide:function(){this._hidden=true;esri.hide(this.domNode);},show:function(){this._hidden=false;esri.show(this.domNode);},destroy:function(){_2.disconnect(this._mapOnPan);_2.disconnect(this._mapOnExtentChange);_2.disconnect(this._mapOnLayerAdd);_2.disconnect(this._mapOnLayerRemove);this.hide();this.map=null;_2.destroy(this.domNode);},_checkBingMaps:function(){if(_2.hasClass(this.domNode,"scalebar_bottom-left")){_2.style(this.domNode,"left","25px");_2.forEach(this.map.layerIds,function(_e,_f){if(this.map.getLayer(_e).declaredClass==="esri.virtualearth.VETiledLayer"&&this.map.getLayer(_e).visible){var _10="95px";if(this.map._mapParams.nav){_10="115px";}_2.style(this.domNode,"left",_10);}},this);}},_getDistance:function(_11){var _12=_2.position(this.domNode,true);var _13=_12.y-this.map.position.y;_13=(_13>this.map.height)?this.map.height:_13;_13=(_13<0)?0:_13;var _14=new esri.geometry.Point(0,_13,this.map.spatialReference);var _15=new esri.geometry.Point(this.map.width,_13,this.map.spatialReference);var _16,_17;this.mapUnit="esriDecimalDegrees";var pt1=esri.geometry.toMapPoint(_11,this.map.width,this.map.height,_14);var pt2=esri.geometry.toMapPoint(_11,this.map.width,this.map.height,_15);var _18=new esri.geometry.Point(_11.xmin,(_11.ymin+_11.ymax)/2,this.map.spatialReference);var _19=new esri.geometry.Point(_11.xmax,(_11.ymin+_11.ymax)/2,this.map.spatialReference);if(this.map.spatialReference.wkid===3857||this.map.spatialReference.wkid===102100||this.map.spatialReference.wkid===102113||(this.map.spatialReference.wkt&&this.map.spatialReference.wkt.indexOf("WGS_1984_Web_Mercator")!=-1)){pt1=esri.geometry.webMercatorToGeographic(pt1,true);pt2=esri.geometry.webMercatorToGeographic(pt2,true);_18=esri.geometry.webMercatorToGeographic(_18,true);_19=esri.geometry.webMercatorToGeographic(_19,true);}else{if(esri._isDefined(esri.WKIDUnitConversion[this.map.spatialReference.wkid])||(this.map.spatialReference.wkt&&this.map.spatialReference.wkt.indexOf("PROJCS")===0)){this.mapUnit="linearUnit";_16=Math.abs(_11.xmax-_11.xmin);var _1a;if(esri._isDefined(esri.WKIDUnitConversion[this.map.spatialReference.wkid])){_1a=esri.WKIDUnitConversion.values[esri.WKIDUnitConversion[this.map.spatialReference.wkid]];}else{var wkt=this.map.spatialReference.wkt;var _1b=wkt.lastIndexOf(",")+1;var end=wkt.lastIndexOf("]]");_1a=parseFloat(wkt.substring(_1b,end));}_16*=_1a;if(this.scalebarUnit==="mi"){_16/=1609;}else{_16/=1000;}}}if(this.mapUnit==="esriDecimalDegrees"){var _1c=new esri.geometry.Polyline(new esri.SpatialReference({wkid:4326}));_1c.addPath([pt1,pt2]);var _1d=esri.geometry._straightLineDensify(_1c,10);_16=esri.geometry.geodesicLengths([_1d],esri.Units.KILOMETERS)[0];var _1e=new esri.geometry.Polyline(new esri.SpatialReference({wkid:4326}));_1e.addPath([_18,_19]);var _1f=esri.geometry._straightLineDensify(_1e,10);_17=esri.geometry.geodesicLengths([_1f],esri.Units.KILOMETERS)[0];if(this.scalebarUnit==="mi"){_16/=1.609;_17/=1.609;}}this._getScaleBarLength(_16);if(_17){if(_16/_17>0.1){if(!this._hidden){esri.show(this.domNode);}}else{esri.hide(this.domNode);}}},_getScaleBarLength:function(_20){var _21=50;var _22=_21*_20/this.map.width;var _23=_22;var i=0;var _24=this.scalebarUnit;if(_23<0.1){if(this.scalebarUnit==="mi"){_23*=5280;_24="ft";}else{if(this.scalebarUnit==="km"){_23*=1000;_24="m";}}}while(_23>=1){_23/=10;i++;}var _25,_26;if(_23>0.5){_25=1;_26=0.5;}else{if(_23>0.3){_25=0.5;_26=0.3;}else{if(_23>0.2){_25=0.3;_26=0.2;}else{if(_23>0.15){_25=0.2;_26=0.15;}else{if(_23>0.1){_25=0.15;_26=0.1;}}}}}var _27=((_25/_23)>=(_23/_26))?_26:_25;var _28=_27/_23;var _29=_21*_28;var _2a=Math.pow(10,i)*_27;this._drawScaleBar(_29,_2a,_24);},_drawScaleBar:function(_2b,_2c,_2d){var _2e=2*Math.round(_2b)+"px";this.domNode.style.width=_2e;_2.forEach(_2.query(".esriScalebarFirstNumber",this.domNode),function(_2f,idx){_2f.innerHTML=_2c;},this);_2.forEach(_2.query(".esriScalebarSecondNumber",this.domNode),function(_30,idx){if(this.mapUnit!=="esriUnknown"){_30.innerHTML=2*_2c+_2d;}else{_30.innerHTML=2*_2c+"Unknown Unit";}},this);}});});