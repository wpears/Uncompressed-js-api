/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define(["dijit","dojo","dojox","dojo/require!dijit/_Widget,dijit/_Templated,dojo/dnd/Mover,dojo/dnd/Moveable,dojo/dnd/move"],function(_1,_2,_3){_2.provide("esri.dijit.OverviewMap");_2.require("dijit._Widget");_2.require("dijit._Templated");_2.require("dojo.dnd.Mover");_2.require("dojo.dnd.Moveable");_2.require("dojo.dnd.move");(function(){var _4=[_2.moduleUrl("esri.dijit","css/OverviewMap.css")];var _5=document.getElementsByTagName("head").item(0),_6,i,il=_4.length;for(i=0;i<il;i++){_6=document.createElement("link");_6.type="text/css";_6.rel="stylesheet";_6.href=_4[i].toString();_5.appendChild(_6);}}());_2.declare("esri.dijit.OverviewMap",[_1._Widget,_1._Templated],{widgetsInTemplate:true,templateString:"<div class=\"esriOverviewMap\">\r\n  <div class=\"ovwContainer\" dojoattachpoint=\"_body\" style=\"width: ${width}px; height: ${height}px;\">\r\n    <div id=\"${id}-map\" style=\"width: 100%; height: 100%;\">\r\n      <div class=\"ovwHighlight\" dojoattachpoint=\"_focusDiv\" title=\"${NLS_drag}\" style=\"border: 1px solid ${color}; background-color: ${color};\"></div>\r\n    </div>\r\n  </div>\r\n  <div class=\"ovwButton ovwController\" title=\"${NLS_show}\" dojoattachpoint=\"_controllerDiv\" dojoattachevent=\"onclick: _visibilityHandler\">\r\n  </div>\r\n  <div class=\"ovwButton ovwMaximizer\" title=\"${NLS_maximize}\" dojoattachpoint=\"_maximizerDiv\" dojoattachevent=\"onclick: _maximizeHandler\">\r\n  </div>\r\n</div>\r\n",basePath:_2.moduleUrl("esri.dijit"),constructor:function(_7,_8){_2.mixin(this,esri.bundle.widgets.overviewMap);_7=_7||{};if(!_7.map){console.error("esri.dijit.OverviewMap: "+this.NLS_noMap);return;}var _9={};if(_8){this._detached=true;_9=_2.coords(_8,true);}this.map=_7.map;this.baseLayer=_7.baseLayer;this.width=_7.width||_9.w||this.map.width/4;this.height=_7.height||_9.h||this.map.height/4;this.attachTo=_7.attachTo||"top-right";this.expandFactor=_7.expandFactor||2;this.color=_7.color||"#000000";this.opacity=_7.opacity||0.5;this.maximizeButton=!!_7.maximizeButton;this.visible=!!_7.visible;this._mainMapLayer=this.map.getLayer(this.map.layerIds[0]);if(!this._mainMapLayer){console.error("esri.dijit.OverviewMap: "+this.NLS_noLayer);return;}var _a=this.baseLayer||this._mainMapLayer;var _b=this.map.spatialReference,_c=_a.spatialReference;if((_c.wkid!==_b.wkid)&&(_c.wkt!==_b.wkt)){console.error("esri.dijit.OverviewMap: "+this.NLS_invalidSR);return;}var _d=_a.declaredClass;if(_a instanceof esri.layers.TiledMapServiceLayer){if(_7.baseLayer){this.baseLayer=_7.baseLayer;}else{if(_d.indexOf("VETiledLayer")!==-1){this.baseLayer=new esri.virtualearth.VETiledLayer({resourceInfo:_a.getResourceInfo(),culture:_a.culture,mapStyle:_a.mapStyle,bingMapsKey:_a.bingMapsKey});}else{if(_d.indexOf("OpenStreetMapLayer")!==-1){this.baseLayer=new esri.layers.OpenStreetMapLayer({tileServers:_a.tileServers});}else{this.baseLayer=new esri.layers.ArcGISTiledMapServiceLayer(_a.url,{resourceInfo:_a.getResourceInfo()});}}}}else{if(_a instanceof esri.layers.DynamicMapServiceLayer){if(_7.baseLayer){this.baseLayer=_7.baseLayer;}else{if(_d.indexOf("ArcGISImageServiceLayer")!==-1){this.baseLayer=new esri.layers.ArcGISImageServiceLayer(_a.url);}else{this.baseLayer=new esri.layers.ArcGISDynamicMapServiceLayer(_a.url);this.baseLayer.setImageFormat("png24");}}}else{console.error("esri.dijit.OverviewMap: "+this.NLS_invalidType);return;}}if(this._detached){this.visible=true;}this._maximized=false;},startup:function(){this.inherited(arguments);if(_2.isIE){if(!this.domNode.parentElement){this.map.container.appendChild(this.domNode);}}else{if(!this.domNode.parentNode){this.map.container.appendChild(this.domNode);}}if(this._detached){_2.style(this._body,"display","block");_2.style(this._controllerDiv,"display","none");_2.style(this._maximizerDiv,"display","none");if(this.baseLayer.loaded){this._initialize();}else{_2.connect(this.baseLayer,"onLoad",this,this._initialize);}}else{if(this.attachTo.split("-")[0]==="bottom"){this.domNode.insertBefore(this._maximizerDiv,this._controllerDiv);}if(!this.maximizeButton){_2.addClass(this._maximizerDiv,"ovwDisabledButton");}_2.addClass(this.domNode,{"top-left":"ovwTL","top-right":"ovwTR","bottom-left":"ovwBL","bottom-right":"ovwBR"}[this.attachTo]);_2.addClass(this._controllerDiv,"ovwShow");_2.addClass(this._maximizerDiv,"ovwMaximize");if(this.visible){var _e=function(){this.visible=false;this._show();};if(this.baseLayer.loaded){_e.call(this);}else{_2.connect(this.baseLayer,"onLoad",this,_e);}}}_2.style(this._focusDiv,"opacity",this.opacity);},destroy:function(){this._deactivate();if(this.overviewMap){this.overviewMap.destroy();}this.overviewMap=this.baseLayer=null;this.inherited(arguments);},resize:function(_f){if(!_f||_f.w<=0||_f.h<=0){return;}this._resize(_f.w,_f.h);},_visibilityHandler:function(){if(this.visible){this._hide();}else{this._show();}},_show:function(){if(!this.visible){var div=this._controllerDiv;div.title=this.NLS_hide;_2.removeClass(div,"ovwShow");_2.addClass(div,"ovwHide");esri.show(this._body);esri.show(this._maximizerDiv);this._initialize();this.visible=true;}},_hide:function(){if(this.visible){var div=this._controllerDiv;div.title=this.NLS_show;_2.removeClass(div,"ovwHide");_2.addClass(div,"ovwShow");if(this._maximized){this._maximizeHandler();}esri.hide(this._body);esri.hide(this._maximizerDiv);this._deactivate();this.visible=false;}},_maximizeHandler:function(){var div=this._maximizerDiv;if(this._maximized){div.title=this.NLS_maximize;_2.removeClass(div,"ovwRestore");_2.addClass(div,"ovwMaximize");this._resize(this.width,this.height);}else{div.title=this.NLS_restore;_2.removeClass(div,"ovwMaximize");_2.addClass(div,"ovwRestore");this._resize(this.map.width,this.map.height);}this._maximized=!this._maximized;},_resize:function(_10,_11){_2.style(this._body,{width:_10+"px",height:_11+"px"});var _12=esri.config.defaults.map.panDuration,_13=this.overviewMap;esri.config.defaults.map.panDuration=0;_13.resize(true);_13.centerAt(this._focusExtent.getCenter());esri.config.defaults.map.panDuration=_12;},_initialize:function(){if(!this.overviewMap){var _14;_14=(this.overviewMap=new esri.Map(this.id+"-map",{slider:false,lods:this._overviewLods,wrapAround180:this.map.wrapAround180}));_2.connect(_14,"onLoad",this,function(){this._map_resize_override=_2.hitch(_14,this._map_resize_override);_14.disableMapNavigation();this._activate();});_14.addLayer(this.baseLayer);}else{this._activate();}},_activate:function(){var map=this.map,_15=this.overviewMap;this._moveableHandle=new _2.dnd.Moveable(this._focusDiv);this._soeConnect=_2.connect(map,"onExtentChange",this,this._syncOverviewMap);this._ufoConnect=_2.connect(map,"onPan",this,this._updateFocus);this._oecConnect=_2.connect(_15,"onExtentChange",this,this._ovwExtentChangeHandler);this._opaConnect=_2.connect(_15,"onPan",this,this._ovwPanHandler);this._ozsConnect=_2.connect(_15,"onZoomStart",this,function(){esri.hide(this._focusDiv);});this._ozeConnect=_2.connect(_15,"onZoomEnd",this,function(){esri.show(this._focusDiv);});this._omsConnect=_2.connect(this._moveableHandle,"onMoveStop",this,this._moveStopHandler);this._syncOverviewMap(map.extent,null,null,null);},_deactivate:function(){_2.disconnect(this._soeConnect);_2.disconnect(this._ufoConnect);_2.disconnect(this._oecConnect);_2.disconnect(this._opaConnect);_2.disconnect(this._ozsConnect);_2.disconnect(this._ozeConnect);_2.disconnect(this._omsConnect);if(this._moveableHandle){this._moveableHandle.destroy();}},_syncOverviewMap:function(ext,_16,_17,lod){if(this._suspendPanHandling){this._suspendPanHandling=false;return;}this._focusExtent=ext;this.overviewMap.setExtent(ext.expand(this.expandFactor),true);},_updateFocus:function(ext){if(this._suspendPanHandling){return;}this._focusExtent=ext;this._drawFocusDiv(ext);},_drawFocusDiv:function(ext,_18){var _19=this.overviewMap;var tl=_19.toScreen(new esri.geometry.Point(ext.xmin,ext.ymax,_19.spatialReference));var br=_19.toScreen(new esri.geometry.Point(ext.xmax,ext.ymin,_19.spatialReference));var _1a=br.x-tl.x,_1b=br.y-tl.y,_1c=true;if((_1a>this.overviewMap.width)&&(_1b>this.overviewMap.height)){_1c=false;}_2.style(this._focusDiv,{left:tl.x+(_18?_18.x:0)+"px",top:tl.y+(_18?_18.y:0)+"px",width:_1a+"px",height:_1b+"px",display:_1c?"block":"none"});},_moveStopHandler:function(evt){var _1d=this._moveableHandle.node.style;var ext=this._focusExtent;var _1e=this.overviewMap;var _1f=_1e.toMap(new esri.geometry.Point(parseInt(_1d.left,10),parseInt(_1d.top,10)));var _20=new esri.geometry.Point(ext.xmin,ext.ymax,_1e.spatialReference);this._focusExtent=ext.offset(_1f.x-_20.x,_1f.y-_20.y);if(this._maximized){this._maximizeHandler();}else{_1e.centerAt(this._focusExtent.getCenter());}this._suspendPanHandling=true;this.map.setExtent(this._focusExtent);},_ovwExtentChangeHandler:function(){this._drawFocusDiv(this._focusExtent);},_ovwPanHandler:function(ext,_21){this._drawFocusDiv(this._focusExtent,_21);}});});