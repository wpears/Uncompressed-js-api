/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define(["dijit","dojo","dojox","dojo/require!esri/virtualearth/VETiledLayer,esri/layers/osm,dijit/_Widget,dijit/_Templated,dojo/DeferredList"],function(_1,_2,_3){_2.provide("esri.dijit.BasemapGallery");_2.require("esri.virtualearth.VETiledLayer");_2.require("esri.layers.osm");_2.require("dijit._Widget");_2.require("dijit._Templated");_2.require("dojo.DeferredList");(function(){var _4=[_2.moduleUrl("esri.dijit","css/BasemapGallery.css")];var _5=document.getElementsByTagName("head").item(0),_6;for(var i=0,il=_4.length;i<il;i++){_6=document.createElement("link");_6.type="text/css";_6.rel="stylesheet";_6.href=_4[i].toString();_5.appendChild(_6);}}());esri.dijit._arcgisUrl="http://www.arcgis.com/sharing/rest";_2.declare("esri.dijit.BasemapGallery",[_1._Widget,_1._Templated],{widgetsInTemplate:true,templateString:"<div class=\"esriBasemapGallery\">\r\n  <div dojoAttachPoint=\"flowContainer\">\r\n  </div>\r\n</div>",basePath:_2.moduleUrl("esri.dijit"),loaded:false,basemaps:[],bingMapsKey:null,flowContainer:null,_hasUI:false,_selectedBasemap:null,constructor:function(_7,_8){_7=_7||{};if(!_7.map){console.error("esri.dijit.BasemapGallery: Unable to find the 'map' property in parameters");}this.map=_7.map;this._hasUI=_8?true:false;this.bingMapsKey=(_7.bingMapsKey&&_7.bingMapsKey.length>0)?_7.bingMapsKey:null;this.showArcGISBasemaps=(_7.showArcGISBasemaps===false)?false:true;this.basemaps=_7.basemaps?_7.basemaps:[];this.basemapIds=_7.basemapIds;this.referenceIds=_7.referenceIds;this.basemapsGroup=_7.basemapsGroup;if(location.protocol==="https:"){esri.dijit._arcgisUrl=esri.dijit._arcgisUrl.replace("http:","https:");}this.init();},init:function(){this.inherited(arguments);_2.forEach(this.basemaps,function(_9,i){if(!_9.id||_9.id.length===0){_9.id=this._getUniqueId();}_2.forEach(_9.layers,function(_a){_a.opacity=(_a.opacity>=0)?_a.opacity:1;_a.visibility=true;},this);},this);if(this.basemapIds&&this.basemapIds.length>0){_2.forEach(this.basemapIds,function(_b){var _c=this.map.getLayer(_b);_c._basemapGalleryLayerType="basemap";},this);}if(this.referenceIds&&this.referenceIds.length>0){_2.forEach(this.referenceIds,function(_d){var _e=this.map.getLayer(_d);_e._basemapGalleryLayerType="reference";},this);}if(this.basemapsGroup&&((this.basemapsGroup.owner&&this.basemapsGroup.title)||this.basemapsGroup.id)){this._findCustomBasemapsGroup(_2.hitch(this,"_handleArcGISBasemapsResponse"));}else{if(this.showArcGISBasemaps){this._findArcGISBasemapsGroup(_2.hitch(this,"_handleArcGISBasemapsResponse"));}else{this._finishStartup();}}},startup:function(){if(this.loaded){this._refreshUI();}else{_2.connect(this,"onLoad",_2.hitch(this,function(){this._refreshUI();}));}},select:function(id){this._select(id);},getSelected:function(){return this._selectedBasemap;},get:function(id){for(var i=0;i<this.basemaps.length;i++){if(this.basemaps[i].id==id){return this.basemaps[i];}}return null;},add:function(_f){if(_f&&!_f.id){_f.id=this._getUniqueId();this.basemaps.push(_f);this._refreshUI();this.onAdd(_f);return true;}else{if(_f&&this._isUniqueId(_f.id)){this.basemaps.push(_f);this._refreshUI();this.onAdd(_f);return true;}}return false;},remove:function(id){for(var i=0;i<this.basemaps.length;i++){var _10=this.basemaps[i];if(_10.id===id){if(this._selectedBasemap&&this._selectedBasemap.id===_10.id){this._selectedBasemap=null;}this.basemaps.splice(i,1);this._refreshUI();this.onRemove(_10);return _10;}}return null;},onLoad:function(){},onSelectionChange:function(){},onAdd:function(_11){},onRemove:function(_12){},onError:function(msg){},_defaultBasemapGalleryGroupQuery:"title:\"ArcGIS Online Basemaps\" AND owner:esri",_basemapGalleryGroupQuery:null,_finishStartup:function(){this.loaded=true;this.onLoad();if(this.map.layerIds.length===0&&this.basemaps.length>0){this._select(this.basemaps[0].id);}},_findCustomBasemapsGroup:function(_13){if(this.basemapsGroup&&this.basemapsGroup.id){this._findArcGISBasemaps(this.basemapsGroup.id,_13);}else{this._basemapGalleryGroupQuery="title:\""+this.basemapsGroup.title+"\" AND owner:"+this.basemapsGroup.owner;this._findArcGISBasemapsGroup(_13);}},_findArcGISBasemapsGroup:function(_14){if(!this._basemapGalleryGroupQuery){var url=esri.dijit._arcgisUrl+"/accounts/self";var _15={};_15.f="json";_15.culture=_2.locale;esri.request({url:url,content:_15,callbackParamName:"callback",load:_2.hitch(this,function(_16,_17){if(_16&&_16.basemapGalleryGroupQuery){this._basemapGalleryGroupQuery=_16.basemapGalleryGroupQuery;}else{this._basemapGalleryGroupQuery=this._defaultBasemapGalleryGroupQuery;}this._findArcGISBasemapsGroupContent(_14);}),error:function(_18,_19){this._basemapGalleryGroupQuery=this._defaultBasemapGalleryGroupQuery;}});}else{this._findArcGISBasemapsGroupContent(_14);}},_findArcGISBasemapsGroupContent:function(_1a){var _1b=_2.hitch(this,"_findArcGISBasemaps");var url=esri.dijit._arcgisUrl+"/community/groups";var _1c={};_1c.q=this._basemapGalleryGroupQuery;_1c.f="json";esri.request({url:url,content:_1c,callbackParamName:"callback",load:function(_1d,_1e){if(_1d.results.length>0){_1b(_1d.results[0].id,_1a);}else{console.error("esri.dijit.BasemapGallery: could not find group for basemaps.");}},error:esriConfig.defaults.io.errorHandler});},_findArcGISBasemaps:function(_1f,_20){var url=esri.dijit._arcgisUrl+"/search";var _21={};_21.q="group:"+_1f+" AND type:\"web map\"";_21.sortField="name";_21.sortOrder="desc";_21.num=50;_21.f="json";esri.request({url:url,content:_21,callbackParamName:"callback",load:function(_22,_23){_20(_22.results);},error:esriConfig.defaults.io.errorHandler});},_handleArcGISBasemapsResponse:function(_24){if(_24.length>0){_2.forEach(_24,function(_25,i){if(this.bingMapsKey||(!this.bingMapsKey&&_25.title&&_25.title.indexOf("Bing Maps")==-1)){var _26={};_26.id=this._getUniqueId();_26.title=_25.title;_26.thumbnailUrl=(_25.thumbnail&&_25.thumbnail.length>0)?(esri.dijit._arcgisUrl+"/content/items/"+_25.id+"/info/"+_25.thumbnail):"";_26.itemId=_25.id;var _27=new esri.dijit.Basemap(_26);this.basemaps.splice(0,0,_27);}},this);this._finishStartup();}},_refreshUI:function(){if(this._hasUI){_2.empty(this.flowContainer);_2.forEach(this.basemaps,function(_28,i){if(!_28.id){_28.id="basemap_"+i;}this.flowContainer.appendChild(this._buildNodeLayout(_28));},this);_2.create("br",{style:{clear:"both"}},this.flowContainer);this._markSelected(this._selectedBasemap);}},_buildNodeLayout:function(_29){var nId="galleryNode_"+_29.id;var n=_2.create("div",{id:nId,"class":"esriBasemapGalleryNode"});var _2a=_2.create("a",{href:"#"},n);_2.connect(_2a,"onclick",_2.hitch(this,"_onNodeClick",_29));if(_29.thumbnailUrl){_2.create("img",{"class":"esriBasemapGalleryThumbnail",src:_29.thumbnailUrl},_2a);}else{_2.create("img",{"class":"esriBasemapGalleryThumbnail",src:this.basePath.toString()+"images/transparent.gif"},_2a);}var _2b=_2.create("div",{"class":"esriBasemapGalleryLabelContainer"},n);var _2c=_29.title||"";_2.create("span",{innerHTML:_2c,alt:_2c,title:_2c},_2b);return n;},_onNodeClick:function(_2d,e){e.preventDefault();this._markSelected(_2d);this.select(_2d.id);},_markSelected:function(_2e){if(_2e){_2.forEach(_2.query(".esriBasemapGallerySelectedNode",this.domNode),function(_2f){_2.removeClass(_2f,"esriBasemapGallerySelectedNode");});var _30=_2.byId("galleryNode_"+_2e.id);if(_30){_2.addClass(_30,"esriBasemapGallerySelectedNode");}}},_select:function(id){var _31=this.get(id);if(_31.layers){this._getServiceInfos(_31);}else{var _32=_31.getLayers();if(_2.isArray(_32)){this._getServiceInfos(_31);}else{_32.addCallback(_2.hitch(this,function(_33){this._getServiceInfos(_31);}));}}this._markSelected(_31);},_getServiceInfos:function(_34){if(location.protocol=="https:"){_2.forEach(_34.layers,function(_35){if(this._isAgolService(_35.url)||this._isHostedService(_35.url)){_35.url=_35.url.replace("http:","https:");}},this);}this._selectedBasemap=_34;var _36=[];_2.forEach(_34.layers,function(_37){if(_37.url&&_37.url.length>0&&!_37.isReference){_37.deferredsPos=_36.length;_36.push(this._getServiceInfo(_37.url));}},this);if(_36.length>0){var _38=new _2.DeferredList(_36);_38.addCallback(_2.hitch(this,function(_39){var _3a=null;_2.forEach(_34.layers,function(_3b){if(_3b.deferredsPos===0||_3b.deferredsPos){_3b.serviceInfoResponse=_39[_3b.deferredsPos][1];var ext=_3b.serviceInfoResponse.fullExtent;if(!ext){ext=_3b.serviceInfoResponse.extent;}if(!_3a){_3a=new esri.geometry.Extent(ext);}else{_3a=_3a.union(new esri.geometry.Extent(ext));}}},this);if(this.map.extent){var _3c=this._getIntersectionPercent(_3a,this.map.extent);if(_3c<5){this.map.setExtent(_3a,true);}}this._switchBasemapLayers(_34);this._updateReferenceLayer(_34);}));}else{this._switchBasemapLayers(_34);this._updateReferenceLayer(_34);}},_switchBasemapLayers:function(_3d){var _3e=_3d.layers;if(this.map.layerIds.length>0&&this.map.getNumLevels()===0&&(_3e[0].type==="OpenStreetMap"||(_3e[0].type&&_3e[0].type.indexOf("BingMaps")>-1))){var msg="esri.dijit.BasemapGallery: Unable to switch basemap because new basemap is a tiled service and cannot be loaded as a dynamic layer.";this.onError(msg);return;}_2.forEach(_3e,function(_3f){if(!_3f.isReference&&_3f.type&&_3f.type.indexOf("BingMaps")>-1&&!this.bingMapsKey){var msg="esri.dijit.BasemapGallery: Invalid Bing Maps key.";this.onError(msg);return;}},this);this._removeBasemapLayers();_2.forEach(_3e,function(_40){if(!_40.isReference){var _41;if(_40.type==="OpenStreetMap"){if(this.map.layerIds.length>0&&this.map.getNumLevels()===0){var msg="esri.dijit.BasemapGallery: Unable to switch basemap because new basemap is a tiled service and cannot be loaded as a dynamic layer.";this.onError(msg);return;}_41=new esri.layers.OpenStreetMapLayer({id:"layer_osm",opacity:_40.opacity});}else{if(_40.type&&_40.type.indexOf("BingMaps")>-1){if(this.map.layerIds.length>0&&this.map.getNumLevels()===0){var msg="esri.dijit.BasemapGallery: Unable to switch basemap because new basemap is a tiled service and cannot be loaded as a dynamic layer.";this.onError(msg);return;}var _42=esri.virtualearth.VETiledLayer.MAP_STYLE_AERIAL_WITH_LABELS;if(_40.type=="BingMapsAerial"){_42=esri.virtualearth.VETiledLayer.MAP_STYLE_AERIAL;}else{if(_40.type=="BingMapsRoad"){_42=esri.virtualearth.VETiledLayer.MAP_STYLE_ROAD;}}_41=new esri.virtualearth.VETiledLayer({id:"layer_bing",bingMapsKey:this.bingMapsKey,mapStyle:_42,opacity:_40.opacity});}else{if(_40.serviceInfoResponse&&_40.serviceInfoResponse.mapName){if((this.map.layerIds.length===0||this.map.getNumLevels()>0)&&_40.serviceInfoResponse.singleFusedMapCache===true){_41=this._loadAsCached(_40);}else{_41=this._loadAsDynamic(_40);}}else{if(_40.serviceInfoResponse&&_40.serviceInfoResponse.pixelSizeX){var _43=new esri.layers.ImageServiceParameters();_43.bandIds=_40.bandIds;if(!_40.bandIds&&_40.serviceInfoResponse.bandCount&&parseInt(_40.serviceInfoResponse.bandCount)>3){_43.bandIds=[0,1,2];}_41=new esri.layers.ArcGISImageServiceLayer(_40.url,{resourceInfo:_40.serviceInfoResponse,opacity:_40.opacity,visible:_40.visibility,imageServiceParameters:_43});}}}}if(_41){_41._basemapGalleryLayerType="basemap";this.map.addLayer(_41,0);}}},this);this.onSelectionChange();},_removeBasemapLayers:function(){var _44=this.map.layerIds;var _45=[];_2.forEach(_44,function(id){var _46=this.map.getLayer(id);if(_46._basemapGalleryLayerType==="basemap"){_45.push(_46);}},this);if(_45.length===0&&_44.length>0){_45.push(this.map.getLayer(_44[0]));}if(_45.length>0){_2.forEach(_45,function(_47){this.map.removeLayer(_47);},this);}},_updateReferenceLayer:function(_48){this._removeReferenceLayer();for(var i=0;i<_48.layers.length;i++){if(_48.layers[i].isReference===true){this._addReferenceLayer(_48.layers[i]);}}},_removeReferenceLayer:function(){for(var i=this.map.layerIds.length-1;i>=0;i--){var id=this.map.layerIds[i];var _49=this.map.getLayer(id);if(_49._basemapGalleryLayerType==="reference"){this.map.removeLayer(_49);}}},_addReferenceLayer:function(_4a){this._getServiceInfo(_4a.url,_2.hitch(this,"_handleReferenceServiceInfoResponse",_4a));},_handleReferenceServiceInfoResponse:function(_4b,_4c,_4d){var _4e;_4b.serviceInfoResponse=_4c;if(_4c&&_4c.mapName){if(_4c.singleFusedMapCache===true){_4e=this._loadAsCached(_4b);}else{_4e=this._loadAsDynamic(_4b);}}else{if(_4c&&_4c.pixelSizeX){var _4f=new esri.layers.ImageServiceParameters();_4f.bandIds=_4b.bandIds;if(!_4b.bandIds&&_4c.bandCount&&parseInt(_4c.bandCount)>3){_4f.bandIds=[0,1,2];}_4e=new esri.layers.ArcGISImageServiceLayer(_4b.url,{resourceInfo:_4c,opacity:_4b.opacity,visible:_4b.visibility,imageServiceParameters:_4f});}}if(_4e){_4e._basemapGalleryLayerType="reference";this.map.addLayer(_4e);}},_getServiceInfo:function(url,_50){var _51={};_51.f="json";var _52=esri.request({url:url,content:_51,callbackParamName:"callback",load:function(_53,_54){if(_50){_50(_53,_54);}},error:esriConfig.defaults.io.errorHandler});return _52;},_loadAsCached:function(_55){var _56=[];if(!_55.displayLevels){_56=_2.map(_55.serviceInfoResponse.tileInfo.lods,function(lod){return lod.level;});}var _57=new esri.layers.ArcGISTiledMapServiceLayer(_55.url,{resourceInfo:_55.serviceInfoResponse,opacity:_55.opacity,visible:_55.visibility,displayLevels:(_55.displayLevels)?_55.displayLevels:_56});return _57;},_loadAsDynamic:function(_58){var _59=new esri.layers.ArcGISDynamicMapServiceLayer(_58.url,{resourceInfo:_58.serviceInfoResponse,opacity:_58.opacity,visible:_58.visibility});if(_58.visibleLayers){_59.setVisibleLayers(_58.visibleLayers);}return _59;},_getIntersectionPercent:function(_5a,_5b){var _5c=_5b.intersects(_5a);if(_5c){var _5d=_5c.getWidth()*_5c.getHeight();var _5e=_5b.getWidth()*_5b.getHeight();return (_5d/_5e)*100;}else{return 0;}},_getIds:function(){var ids=[];_2.forEach(this.basemaps,function(_5f){ids.push(_5f.id);},this);return ids;},_getUniqueId:function(){var _60=","+this._getIds().toString()+",";var _61=0;while(true){if(_60.indexOf(",basemap_"+_61+",")>-1){_61++;}else{return "basemap_"+_61;}}},_isUniqueId:function(id){var _62=","+this._getIds().toString()+",";if(_62.indexOf(","+id+",")===-1){return true;}return false;},_isAgolService:function(url){if(!url){return false;}return (url.indexOf("/services.arcgisonline.com/")!==-1||url.indexOf("/server.arcgisonline.com/")!==-1);},_isHostedService:function(url){if(!url){return false;}return (url.indexOf(".arcgis.com/")!==-1);}});_2.declare("esri.dijit.Basemap",null,{id:null,title:"",thumbnailUrl:null,layers:null,itemId:null,constructor:function(_63){_63=_63||{};if(!_63.layers&&!_63.itemId){console.error("esri.dijit.Basemap: unable to find the 'layers' property in parameters");}this.id=_63.id;this.itemId=_63.itemId;this.layers=_63.layers;this.title=_63.title?_63.title:"";this.thumbnailUrl=_63.thumbnailUrl;},getLayers:function(){if(this.layers){return this.layers;}else{if(this.itemId){var url=esri.dijit._arcgisUrl+"/content/items/"+this.itemId+"/data";var _64={};_64.f="json";var _65=esri.request({url:url,content:_64,callbackParamName:"callback",error:esriConfig.defaults.io.errorHandler});_65.addCallback(_2.hitch(this,function(_66,_67){this.layers=[];_2.forEach(_66.baseMap.baseMapLayers,function(_68){var _69={};if(_68.url){_69.url=_68.url;}if(_68.type){_69.type=_68.type;}if(_68.isReference){_69.isReference=_68.isReference;}if(_68.displayLevels){_69.displayLevels=_68.displayLevels;}if(_68.visibleLayers){_69.visibleLayers=_68.visibleLayers;}if(_68.bandIds){_69.bandIds=_68.bandIds;}this.layers.push(new esri.dijit.BasemapLayer(_69));},this);return this.layers;}));return _65;}}}});_2.declare("esri.dijit.BasemapLayer",null,{constructor:function(_6a){_6a=_6a||{};if(!_6a.url&&!_6a.type){console.error("esri.dijit.BasemapLayer: unable to find the 'url' or 'type' property in parameters");}this.url=_6a.url;this.type=_6a.type;this.isReference=(_6a.isReference===true)?true:false;this.displayLevels=_6a.displayLevels;this.visibleLayers=_6a.visibleLayers;this.bandIds=_6a.bandIds;this.opacity=_6a.opacity;}});});