/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define(["dijit","dojo","dojox","dojo/require!esri/layers/layer,esri/geometry,dojox/xml/parser,dojox/gfx/matrix"],function(_1,_2,_3){_2.provide("esri.layers.dynamic");_2.require("esri.layers.layer");_2.require("esri.geometry");_2.require("dojox.xml.parser");_2.require("dojox.gfx.matrix");_2.declare("esri.layers.DynamicMapServiceLayer",esri.layers.Layer,{constructor:function(_4,_5){this.useMapTime=(_5&&_5.hasOwnProperty("useMapTime"))?(!!_5.useMapTime):true;var _6=_2.hitch;this._exportMapImageHandler=_6(this,this._exportMapImageHandler);this._imgSrcFunc=_6(this,this._imgSrcFunc);this._divAlphaImageFunc=_6(this,this._divAlphaImageFunc);this._tileLoadHandler=_6(this,this._tileLoadHandler);this._tileErrorHandler=_6(this,this._tileErrorHandler);},opacity:1,isPNG32:false,_setMap:function(_7,_8,_9){this._map=_7;var d=(this._div=_2.create("div",null,_8)),_a=esri._css.names,_b={position:"absolute",width:_7.width+"px",height:_7.height+"px",overflow:"visible",opacity:this.opacity},_c=_2.isIE,_d=_2.connect,vd=_7.__visibleDelta;if(_c&&_c>7){delete _b.opacity;}if(_7.navigationMode==="css-transforms"){_b[_a.transform]=esri._css.translate(vd.x,vd.y);_2.style(d,_b);this._onScaleHandler_connect=_d(_7,"onScale",this,this._onScaleHandler);this._left=vd.x;this._top=vd.y;}else{_b.left="0px";_b.top="0px";_2.style(d,_b);this._onZoomHandler_connect=_d(_7,"onZoom",this,"_onZoomHandler");this._left=this._top=0;}_2.style(d,_b);this._onPanHandler_connect=_d(_7,"onPan",this,"_onPanHandler");this._onExtentChangeHandler_connect=_d(_7,"onExtentChange",this,"_onExtentChangeHandler");this._onResizeHandler_connect=_d(_7,"onResize",this,"_onResizeHandler");this._opacityChangeHandler_connect=_d(this,"onOpacityChange",this,"_opacityChangeHandler");this._visibilityChangeHandler_connect=_d(this,"onVisibilityChange",this,"_visibilityChangeHandler");this._toggleTime();this._layerIndex=_9;this._img_loading=null;this._dragOrigin={x:0,y:0};if(!this.visible){this._visibilityChangeHandler(this.visible);}else{if(_7.extent&&_7.loaded){this._onExtentChangeHandler(_7.extent);}}return d;},_unsetMap:function(_e,_f){_2.destroy(this._div);this._map=this._layerIndex=this._div=null;var _10=_2.disconnect;_10(this._onPanHandler_connect);_10(this._onExtentChangeHandler_connect);_10(this._onZoomHandler_connect);_10(this._onScaleHandler_connect);_10(this._onResizeHandler_connect);_10(this._opacityChangeHandler_connect);_10(this._visibilityChangeHandler_connect);this._toggleTime();},_onResizeHandler:function(_11,_12,_13){_2.style(this._div,{width:_12+"px",height:_13+"px"});this._onExtentChangeHandler(_11);},_visibilityChangeHandler:function(v){var _14=_2.connect,_15=_2.disconnect,map=this._map;this._toggleTime();if(v){if(map.navigationMode==="css-transforms"){var vd=map.__visibleDelta;this._left=vd.x;this._top=vd.y;_2.style(this._div,esri._css.names.transform,esri._css.translate(this._left,this._top));}this._onExtentChangeHandler(map.extent);this._onPanHandler_connect=_14(map,"onPan",this,"_onPanHandler");this._onExtentChangeHandler_connect=_14(map,"onExtentChange",this,"_onExtentChangeHandler");if(map.navigationMode==="css-transforms"){this._onScaleHandler_connect=_14(map,"onScale",this,this._onScaleHandler);}else{this._onZoomHandler_connect=_14(map,"onZoom",this,"_onZoomHandler");}}else{esri.hide(this._div);_15(this._onPanHandler_connect);_15(this._onExtentChangeHandler_connect);_15(this._onZoomHandler_connect);_15(this._onScaleHandler_connect);}},_toggleTime:function(){var map=this._map;if(this.timeInfo&&this.useMapTime&&map&&this.visible){if(!this._timeConnect){this._timeConnect=_2.connect(map,"onTimeExtentChange",this,this._onTimeExtentChangeHandler);}this._setTime(map.timeExtent);}else{_2.disconnect(this._timeConnect);this._timeConnect=null;this._setTime(null);}},_setTime:function(_16){if(this._params){this._params.time=_16?_16.toJson().join(","):null;}},_onPanHandler:function(_17,_18){this._panDx=_18.x;this._panDy=_18.y;var _19=this._dragOrigin,vd=this._map.__visibleDelta,img=this._img;if(img){if(this._map.navigationMode==="css-transforms"){this._left=vd.x+_18.x;this._top=vd.y+_18.y;_2.style(this._div,esri._css.names.transform,esri._css.translate(this._left,this._top));}else{_2.style(img,{left:(_19.x+_18.x)+"px",top:(_19.y+_18.y)+"px"});}}},_onExtentChangeHandler:function(_1a,_1b,_1c){if(!this.visible){return;}var _1d=this._map,_1e=this._img,_1f=_1e&&_1e.style,_20=this._dragOrigin;if(_1b&&!_1c&&_1e&&(_1b.x!==this._panDx||_1b.y!==this._panDy)){if(_1d.navigationMode==="css-transforms"){var vd=_1d.__visibleDelta;this._left=vd.x;this._top=vd.y;_2.style(this._div,esri._css.names.transform,esri._css.translate(this._left,this._top));}else{_2.style(_1e,{left:(_20.x+_1b.x)+"px",top:(_20.y+_1b.y)+"px"});}}if(_1e){_20.x=parseInt(_1f.left,10);_20.y=parseInt(_1f.top,10);}else{_20.x=(_20.y=0);}if(_1d.navigationMode==="css-transforms"){if(_1c&&_1e){_2.style(_1e,esri._css.names.transition,"none");_1e._multiply=_1e._multiply?_3.gfx.matrix.multiply(_1e._matrix,_1e._multiply):_1e._matrix;}}this._fireUpdateStart();var _21=this._img_loading;if(_21){_2.disconnect(_21._onload_connect);_2.disconnect(_21._onerror_connect);_2.disconnect(_21._onabort_connect);_2.destroy(_21);this._img_loading=null;var _22=this._jsonRequest;if(_22){try{_22.cancel();}catch(e){}this._jsonRequest=null;}}if(this.version>=10&&_1d.wrapAround180){_1a=_1a._normalize(true);}if(this.isPNG32){var div=(this._img_loading=_2.create("div"));div.id=_1d.id+"_"+this.id+"_"+new Date().getTime();_2.style(div,{position:"absolute",left:"0px",top:"0px",width:_1d.width+"px",height:_1d.height+"px"});var _23=div.appendChild(_2.create("div"));_2.style(_23,{opacity:0,width:_1d.width+"px",height:_1d.height+"px"});this.getImageUrl(_1a,_1d.width,_1d.height,this._divAlphaImageFunc);div=null;}else{var img=(this._img_loading=_2.create("img")),_24=esri._css.names,_25=_2.isIE,css={position:"absolute",width:_1d.width+"px",height:_1d.height+"px"};if(_25&&_25>7){css.opacity=this.opacity;}if(_1d.navigationMode==="css-transforms"){css[_24.transform]=esri._css.translate(-this._left,-this._top);img._tdx=-this._left;img._tdy=-this._top;css[_24.transition]=_24.transformName+" "+esri.config.defaults.map.zoomDuration+"ms ease";}else{css.left="0px";css.top="0px";}img.id=_1d.id+"_"+this.id+"_"+new Date().getTime();_2.style(img,css);img._onload_connect=_2.connect(img,"onload",this,"_onLoadHandler");img._onerror_connect=_2.connect(img,"onerror",this,"_onErrorHandler");img._onabort_connect=_2.connect(img,"onabort",this,"_onErrorHandler");this._startRect={left:_20.x,top:_20.y,width:_1e?parseInt(_1f.width,10):_1d.width,height:_1e?parseInt(_1f.height,10):_1d.height,zoom:(_1f&&_1f.zoom)?parseFloat(_1f.zoom):1};this.getImageUrl(_1a,_1d.width,_1d.height,this._imgSrcFunc);img=null;}},_onTimeExtentChangeHandler:function(_26){if(!this.visible){return;}this._setTime(_26);this.refresh(true);},getImageUrl:function(_27,wd,ht,_28){},_imgSrcFunc:function(src){this._img_loading.src=src;},_divAlphaImageFunc:function(src){_2.style(this._img_loading,"filter","progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+src+"', sizingMethod='scale')");this._onLoadHandler({currentTarget:this._img_loading});},_onLoadHandler:function(evt){var img=evt.currentTarget,_29=_2.disconnect,_2a=this._map;_29(img._onload_connect);_29(img._onerror_connect);_29(img._onabort_connect);if(!_2a||_2a.__panning||_2a.__zooming){_2.destroy(img);this._fireUpdateEnd();return;}_3.xml.parser.removeChildren(this._div);this._img=img;this._startRect={left:0,top:0,width:_2a.width,height:_2a.height,zoom:1};this._div.appendChild(img);if(this.visible){esri.show(this._div);}img._onload_connect=img._onerror_connect=img._onabort_connect=this._img_loading=null;var _2b=this._dragOrigin;_2b.x=(_2b.y=0);this.onUpdate();this._fireUpdateEnd();},_onErrorHandler:function(evt){var img=evt.currentTarget,_2c=_2.disconnect;_2.style(img,"visibility","hidden");_2c(img._onload_connect);_2c(img._onerror_connect);_2c(img._onabort_connect);img._onload_connect=img._onerror_connect=img._onabort_connect=null;var _2d=new Error(esri.bundle.layers.dynamic.imageError+": "+img.src);this.onError(_2d);this._fireUpdateEnd(_2d);},setUseMapTime:function(use,_2e){this.useMapTime=use;this._toggleTime();if(!_2e){this.refresh(true);}},refresh:function(){if(this._map){this._onExtentChangeHandler(this._map.extent);}},_onScaleHandler:function(mtx,_2f){var css={},_30=esri._css.names,img=this._img;if(!img){return;}_2.style(img,_30.transition,_2f?"none":(_30.transformName+" "+esri.config.defaults.map.zoomDuration+"ms ease"));img._matrix=mtx;mtx=img._multiply?_3.gfx.matrix.multiply(mtx,img._multiply):mtx;if(img._tdx||img._tdy){mtx=_3.gfx.matrix.multiply(mtx,{"xx":1,"xy":0,"yx":0,"yy":1,"dx":img._tdx,"dy":img._tdy});}css[_30.transform]=esri._css.matrix(mtx);_2.style(img,css);},_onZoomHandler:function(_31,_32,_33){var _34=this._startRect,_35=_34.width*_32,_36=_34.height*_32,img=this._img,_37=_2.isIE;if(img){if(_37&&_37<8){_2.style(img,{left:(_34.left-((_35-_34.width)*(_33.x-_34.left)/_34.width))+"px",top:(_34.top-((_36-_34.height)*(_33.y-_34.top)/_34.height))+"px",zoom:_32*_34.zoom});}else{_2.style(img,{left:(_34.left-((_35-_34.width)*(_33.x-_34.left)/_34.width))+"px",top:(_34.top-((_36-_34.height)*(_33.y-_34.top)/_34.height))+"px",width:_35+"px",height:_36+"px"});}}},_exportMapImage:function(url,_38,_39){var _3a=this._exportMapImageHandler;_38.token=this._getToken();esri.request({url:url,content:_38,callbackParamName:"callback",load:function(){_3a(arguments[0],arguments[1],_39);},error:esri.config.defaults.io.errorHandler});},_exportMapImageHandler:function(_3b,io,_3c){var _3d=new esri.layers.MapImage(_3b);this.onMapImageExport(_3d);if(_3c){_3c(_3d);}},onMapImageExport:function(){},setOpacity:function(o){if(this.opacity!=o){this.onOpacityChange(this.opacity=o);}},onOpacityChange:function(){},_opacityChangeHandler:function(_3e){_2.style(this._div,"opacity",_3e);}});});