/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define(["dijit","dojo","dojox","dojo/require!esri/utils,esri/layers/layer,esri/geometry"],function(_1,_2,_3){_2.provide("esri.layers.MapImageLayer");_2.require("esri.utils");_2.require("esri.layers.layer");_2.require("esri.geometry");_2.declare("esri.layers.MapImageLayer",[esri.layers.Layer],{"-chains-":{constructor:"manual"},constructor:function(_4){this.inherited(arguments,[null,_4]);this._mapImages=[];var _5=_2.hitch;this._panStart=_5(this,this._panStart);this._pan=_5(this,this._pan);this._extentChange=_5(this,this._extentChange);this._zoom=_5(this,this._zoom);this._zoomStart=_5(this,this._zoomStart);this._scale=_5(this,this._scale);this._resize=_5(this,this._resize);this.loaded=true;this.onLoad(this);},opacity:1,_transform:esri._getDOMAccessor("transform"),addImage:function(_6){var _7=this._mapImages.push(_6);_7=_7-1;_6._idx=_7;_6._layer=this;if(this._div){this._createImage(_6,_7);}},removeImage:function(_8){if(_8){var _9=_8._idx,_a=this._mapImages;if(_a[_9]===_8){delete _a[_9];var _b=_8._node;if(_b){this._clearEvents(_b);_b.e_idx=_b.e_bl=_b.e_tr=_b.e_l=_b.e_t=_b.e_w=_b.e_h=null;if(_b.parentNode){_b.parentNode.removeChild(_b);_2.destroy(_b);}}_8._node=_8._idx=_8._layer=null;}}},removeAllImages:function(){var _c=this._mapImages,i,_d=_c.length;for(i=0;i<_d;i++){var _e=_c[i];if(_e){this.removeImage(_e);}}this._mapImages=[];},getImages:function(){var _f=this._mapImages,_10=[],i,len=_f.length;for(i=0;i<len;i++){if(_f[i]){_10.push(_f[i]);}}return _10;},setOpacity:function(_11){if(this.opacity!=_11){this.onOpacityChange(this.opacity=_11);}},onOpacityChange:function(_12){var div=this._div,i,len,_13;if(div){if(!_2.isIE||_2.isIE>8){_2.style(div,"opacity",_12);}else{_13=div.childNodes;len=_13.length;for(i=0;i<len;i++){_2.style(_13[i],"opacity",_12);}}}},_createImage:function(_14,idx){var _15=_2.create("img");_2.style(_15,{position:"absolute"});if(_2.isIE<=8){_2.style(_15,"opacity",this.opacity);}if(_14.rotation){var _16="rotate("+(360-_14.rotation)+"deg)";if(_2.isIE<9){}else{_2.style(_15,this._transform,_16);_2.style(_15,"transform",_16);}}_14._node=_15;_15.e_idx=idx;_15.e_layer=this;_15.e_load=_2.connect(_15,"onload",esri.layers.MapImageLayer.prototype._imageLoaded);_15.e_error=_2.connect(_15,"onerror",esri.layers.MapImageLayer.prototype._imageError);_15.e_abort=_2.connect(_15,"onabort",esri.layers.MapImageLayer.prototype._imageError);_15.src=_14.href;},_imageLoaded:function(evt,img){var _17=img||evt.target||evt.currentTarget,_18=_17.e_layer,_19=_18._mapImages[_17.e_idx];if(_18._map&&(_18._map.__zooming||_18._map.__panning)){_18._standby.push(_17);return;}_18._clearEvents(_17);if(!_19||_19._node!==_17){return;}if(_18._map){_18._attach(_19);}},_imageError:function(evt){var _1a=evt.target||evt.currentTarget,_1b=_1a.e_layer,_1c=_1b._mapImages[_1a.e_idx];_1b._clearEvents(_1a);if(_1c){_1c._node=null;}},_clearEvents:function(_1d){var _1e=_2.disconnect;_1e(_1d.e_load);_1e(_1d.e_error);_1e(_1d.e_abort);_1d.e_load=_1d.e_error=_1d.e_abort=_1d.e_layer=null;},_attach:function(_1f){var _20=_1f.extent,_21,_22=_20.spatialReference,_23=this._sr,div=this._div,_24=_1f._node,_25=new esri.geometry.Point({x:_20.xmin,y:_20.ymin}),_26=new esri.geometry.Point({x:_20.xmax,y:_20.ymax});if(_23.wkid){_21=(_23._isWebMercator()&&_22._isWebMercator())||(_23.wkid===_22.wkid);}else{if(_23.wkt){_21=(_23.wkt===_22.wkt);}}if(!_21){if(_23._isWebMercator()&&_22.wkid===4326){_25=esri.geometry.geographicToWebMercator(_25);_26=esri.geometry.geographicToWebMercator(_26);}else{if(_22._isWebMercator()&&_23.wkid===4326){_25=esri.geometry.webMercatorToGeographic(_25);_26=esri.geometry.webMercatorToGeographic(_26);}}}_24.e_bl=_25;_24.e_tr=_26;if(_1f.visible){this._setPos(_24,div._left,div._top);(this._active||div).appendChild(_24);}},_setPos:function(_27,_28,_29){var _2a=_27.e_bl,_2b=_27.e_tr,map=this._map;_2a=map.toScreen(_2a);_2b=map.toScreen(_2b);var _2c=_2a.x-_28,top=_2b.y-_29,_2d=Math.abs(_2b.x-_2a.x),_2e=Math.abs(_2a.y-_2b.y),css={width:_2d+"px",height:_2e+"px"},_2f=this._mapImages[_27.e_idx];if(map.navigationMode==="css-transforms"){css[esri._css.names.transform]=esri._css.translate(_2c,top)+(_2f.rotation?(" "+esri._css.rotate(360-_2f.rotation)):"");}else{css.left=_2c+"px";css.top=top+"px";}_2.style(_27,css);_27.e_l=_2c;_27.e_t=top;_27.e_w=_2d;_27.e_h=_2e;},_setMap:function(map,_30){this._map=map;this._sr=map.spatialReference;var div=this._div=_2.create("div",null,_30),_31=esri._css.names,css={position:"absolute"},vd=map.__visibleDelta;if(!_2.isIE||_2.isIE>8){css.opacity=this.opacity;}if(map.navigationMode==="css-transforms"){css[_31.transform]=esri._css.translate(vd.x,vd.y);_2.style(div,css);div._left=vd.x;div._top=vd.y;css={position:"absolute",width:map.width+"px",height:map.height+"px",overflow:"visible"};this._active=_2.create("div",null,div);_2.style(this._active,css);this._passive=_2.create("div",null,div);_2.style(this._passive,css);}else{div._left=0;div._top=0;_2.style(div,css);}this._standby=[];var _32=this._mapImages,i,len=_32.length;for(i=0;i<len;i++){var _33=_32[i],_34=_33._node;if(!_34){this._createImage(_33,_33._idx);}}this.onVisibilityChange(this.visible);return div;},_unsetMap:function(map,_35){this._disconnect();var div=this._div;if(div){var _36=this._mapImages,i,len=_36.length;for(i=0;i<len;i++){var _37=_36[i];if(_37){var _38=_37._node;if(_38){this._clearEvents(_38);_38.e_idx=_38.e_bl=_38.e_tr=_38.e_l=_38.e_t=_38.e_w=_38.e_h=null;}_37._node=null;}}_35.removeChild(div);_2.destroy(div);}this._map=this._div=this._sr=this._active=this._passive=this._standby=null;},onVisibilityChange:function(_39){var div=this._div;if(div){if(_39){this._redraw();this._connect(this._map);esri.show(div);}else{this._disconnect();esri.hide(div);}}},_connect:function(map){if(!this._connections){var _3a=_2.connect,_3b=(map.navigationMode==="css-transforms");this._connections=[_3a(map,"onPanStart",this._panStart),_3a(map,"onPan",this._pan),_3a(map,"onExtentChange",this._extentChange),_3b&&_3a(map,"onZoomStart",this._zoomStart),_3b?_3a(map,"onScale",this._scale):_3a(map,"onZoom",this._zoom),_3b&&_3a(map,"onResize",this._resize)];}},_disconnect:function(){if(this._connections){_2.forEach(this._connections,_2.disconnect);this._connections=null;}},_panStart:function(){this._panL=this._div._left;this._panT=this._div._top;},_pan:function(_3c,_3d){var div=this._div;div._left=this._panL+_3d.x;div._top=this._panT+_3d.y;if(this._map.navigationMode==="css-transforms"){_2.style(div,esri._css.names.transform,esri._css.translate(div._left,div._top));}else{_2.style(div,{left:div._left+"px",top:div._top+"px"});}},_extentChange:function(_3e,_3f,_40){if(_40){this._redraw(this._map.navigationMode==="css-transforms");}else{if(_3f){this._pan(_3e,_3f);}}var i,_41=this._standby;if(_41&&_41.length){for(i=_41.length-1;i>=0;i--){this._imageLoaded(null,_41[i]);_41.splice(i,1);}}},_redraw:function(_42){if(_42){var _43=this._passive,_44=esri._css.names;_2.style(_43,_44.transition,"none");this._moveImages(_43,this._active);_2.style(_43,_44.transform,"none");}var div=this._active||this._div,_45=this._div._left,_46=this._div._top,i,len=div.childNodes.length,_47;for(i=0;i<len;i++){_47=div.childNodes[i];this._setPos(_47,_45,_46);}},_zoom:function(_48,_49,_4a){var div=this._div,_4b=div._left,_4c=div._top,i,len=div.childNodes.length,_4d;for(i=0;i<len;i++){_4d=div.childNodes[i];var _4e=_4d.e_w*_49,_4f=_4d.e_h*_49,_50=(_4a.x-_4b-_4d.e_l)*(_4e-_4d.e_w)/_4d.e_w,_51=(_4a.y-_4c-_4d.e_t)*(_4f-_4d.e_h)/_4d.e_h;_50=isNaN(_50)?0:_50;_51=isNaN(_51)?0:_51;_2.style(_4d,{left:(_4d.e_l-_50)+"px",top:(_4d.e_t-_51)+"px",width:_4e+"px",height:_4f+"px"});}},_zoomStart:function(){this._moveImages(this._active,this._passive);},_moveImages:function(_52,_53){var _54=_52.childNodes,i,len=_54.length;if(len>0){for(i=len-1;i>=0;i--){_53.appendChild(_54[i]);}}},_scale:function(mtx,_55){var css={},_56=esri._css.names,_57=this._passive;_2.style(_57,_56.transition,_55?"none":(_56.transformName+" "+esri.config.defaults.map.zoomDuration+"ms ease"));css[_56.transform]=esri._css.matrix(mtx);_2.style(_57,_56.transform,esri._css.matrix(mtx));},_resize:function(_58,_59,_5a){_2.style(this._active,{width:_59+"px",height:_5a+"px"});_2.style(this._passive,{width:_59+"px",height:_5a+"px"});}});_2.extend(esri.layers.MapImage,{visible:true,getLayer:function(){return this._layer;},getNode:function(){return this._node;},show:function(){if(!this.visible){this.visible=true;var _5b=this._node,_5c=this._layer,div;if(_5b){div=_5c&&_5c._div;if(div){_5c._setPos(_5b,div._left,div._top);(_5c._active||div).appendChild(_5b);}esri.show(_5b);}}},hide:function(){if(this.visible){this.visible=false;var _5d=this._node;if(_5d){esri.hide(_5d);if(_5d.parentNode){_5d.parentNode.removeChild(_5d);}}}}});});