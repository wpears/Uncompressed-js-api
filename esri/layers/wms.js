/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define(["dijit","dojo","dojox","dojo/require!esri/layers/dynamic,esri/layers/agscommon"],function(_1,_2,_3){_2.provide("esri.layers.wms");_2.require("esri.layers.dynamic");_2.require("esri.layers.agscommon");_2.declare("esri.layers.WMSLayer",[esri.layers.DynamicMapServiceLayer],{_CRS_TO_EPSG:{84:4326,83:4269,27:4267},_REVERSED_LAT_LONG_RANGES:[[4001,4999],[2044,2045],[2081,2083],[2085,2086],[2093,2093],[2096,2098],[2105,2132],[2169,2170],[2176,2180],[2193,2193],[2200,2200],[2206,2212],[2319,2319],[2320,2462],[2523,2549],[2551,2735],[2738,2758],[2935,2941],[2953,2953],[3006,3030],[3034,3035],[3058,3059],[3068,3068],[3114,3118],[3126,3138],[3300,3301],[3328,3335],[3346,3346],[3350,3352],[3366,3366],[3416,3416],[20004,20032],[20064,20092],[21413,21423],[21473,21483],[21896,21899],[22171,22177],[22181,22187],[22191,22197],[25884,25884],[27205,27232],[27391,27398],[27492,27492],[28402,28432],[28462,28492],[30161,30179],[30800,30800],[31251,31259],[31275,31279],[31281,31290],[31466,31700]],_WEB_MERCATOR:[102100,3857,102113,900913],_WORLD_MERCATOR:[3395,54004],allExtents:[],constructor:function(_4,_5){_4=this._stripParameters(_4,["version","service","request","bbox","format","height","width","layers","srs","crs","styles","transparent","bgcolor","exceptions","time","elevation","sld","wfs"]);this.url=_4;this._url=esri.urlToObject(_4);this._getCapabilitiesURL=_4;this._initLayer=_2.hitch(this,this._initLayer);this._parseCapabilities=_2.hitch(this,this._parseCapabilities);this._getCapabilitiesError=_2.hitch(this,this._getCapabilitiesError);if(_5){this.imageFormat=this._getImageFormat(_5.format);this.imageTransparency=(_5.transparent===false)?false:true;this.visibleLayers=_5.visibleLayers?_5.visibleLayers:[];if(_5.resourceInfo){this._readResourceInfo(_5.resourceInfo);}else{this._getCapabilities();}}else{this.imageFormat="image/png";this.imageTransparency=true;this.visibleLayers=[];this._getCapabilities();}this._blankImageURL=require.toUrl("esri/layers")+"/../../../images/pixel.png";},setVisibleLayers:function(_6){_6=this._checkVisibleLayersList(_6);this.visibleLayers=(_6)?_6:[];this.refresh(true);},setImageFormat:function(_7){this.imageFormat=this._getImageFormat(_7);this.refresh(true);},setImageTransparency:function(_8){this.imageTransparency=_8;this.refresh(true);},getImageUrl:function(_9,_a,_b,_c){if(!this.visibleLayers||this.visibleLayers.length===0){_c(this._blankImageURL);return;}var _d=_9.spatialReference.wkid;if(_2.some(this._WEB_MERCATOR,function(el){return el==_d;})){var _e=_2.filter(this.spatialReferences,function(el){return (_2.some(this._WEB_MERCATOR,function(_f){return _f==el;}));},this);if(_e.length==0){_e=_2.filter(this.spatialReferences,function(el){return (_2.some(this._WORLD_MERCATOR,function(el2){return el2==el;}));},this);}if(_e.length>0){_d=_e[0];}else{_d=this._WEB_MERCATOR[0];}}var _10=_2.filter(this.spatialReferences,function(el){return el!==_d;});this.spatialReferences=_10;this.spatialReferences.unshift(_d);var _11=_9.xmin;var _12=_9.xmax;var _13=_9.ymin;var _14=_9.ymax;var _15={};_15.SERVICE="WMS";_15.REQUEST="GetMap";_15.FORMAT=this.imageFormat;_15.TRANSPARENT=this.imageTransparency?"TRUE":"FALSE";_15.STYLES="";_15.VERSION=this.version;_15.LAYERS=this.visibleLayers?this.visibleLayers.toString():null;_15.WIDTH=_a;_15.HEIGHT=_b;if(this.maxWidth<_a){_15.WIDTH=this.maxWidth;}if(this.maxHeight<_b){_15.HEIGHT=this.maxHeight;}var _16=_d?_d:NaN;if(!isNaN(_16)){if(this.version=="1.3.0"){_15.CRS="EPSG:"+_16;}else{_15.SRS="EPSG:"+_16;}}if(this.version=="1.3.0"&&this._useLatLong(_16)){_15.BBOX=_13+","+_11+","+_14+","+_12;}else{_15.BBOX=_11+","+_13+","+_12+","+_14;}var _17=this.getMapURL;_17+=(_17.indexOf("?")==-1)?"?":"";for(var key in _15){_17+=(_17.substring(_17.length-1,_17.length)=="?")?"":"&";_17+=key+"="+_15[key];}_c(_17);},_initLayer:function(_18,io){this.spatialReference=new esri.SpatialReference(this.extent.spatialReference);this.initialExtent=new esri.geometry.Extent(this.extent);this.fullExtent=new esri.geometry.Extent(this.extent);this.visibleLayers=this._checkVisibleLayersList(this.visibleLayers);this.loaded=true;this.onLoad(this);var _19=this._loadCallback;if(_19){delete this._loadCallback;_19(this);}},_readResourceInfo:function(_1a){if(!_1a.extent){console.error("esri.layers.WMSLayer: unable to find the 'extent' property in resourceInfo");return;}if(!_1a.layerInfos){console.error("esri.layers.WMSLayer: unable to find the 'layerInfos' property in resourceInfo");return;}this.extent=_1a.extent;this.allExtents[0]=_1a.extent;this.layerInfos=_1a.layerInfos;this.description=_1a.description?_1a.description:"";this.copyright=_1a.copyright?_1a.copyright:"";this.title=_1a.title?_1a.title:"";this.getMapURL=_1a.getMapURL?_1a.getMapURL:this._getCapabilitiesURL;this.version=_1a.version?_1a.version:"1.3.0";this.maxWidth=_1a.maxWidth?_1a.maxWidth:5000;this.maxHeight=_1a.maxHeight?_1a.maxHeight:5000;this.spatialReferences=_1a.spatialReferences?_1a.spatialReferences:[];this.imageFormat=this._getImageFormat(_1a.format);this._initLayer();},_getCapabilities:function(){var _1b=this._url.query?this._url.query:{};_1b.SERVICE="WMS";_1b.REQUEST="GetCapabilities";var uri=this._url.path+"?";for(var key in _1b){uri+=(uri.substring(uri.length-1,uri.length)=="?")?"":"&";uri+=key+"="+_1b[key];}var _1c=esri.request({url:uri,handleAs:"xml",load:this._parseCapabilities,error:this._getCapabilitiesError},{usePost:false});},_parseCapabilities:function(xml){if(!xml){this.onError("GetCapabilities request for "+this._getCapabilitiesURL+" failed. (Response is null.)");return;}this.version=this._getAttributeValue("WMS_Capabilities","version",xml,null);if(!this.version){this.version=this._getAttributeValue("WMT_MS_Capabilities","version",xml,"1.3.0");}var _1d=this._getTag("Service",xml);this.title=this._getTagValue("Title",_1d,"");if(!this.title||this.title.length==0){this.title=this._getTagValue("Name",_1d,"");}this.copyright=this._getTagValue("AccessConstraints",_1d,"");this.description=this._getTagValue("Abstract",_1d,"");this.maxWidth=parseInt(this._getTagValue("MaxWidth",_1d,5000));this.maxHeight=parseInt(this._getTagValue("MaxHeight",_1d,5000));var _1e=this._getTag("Layer",xml);if(!_1e){this._getCapabilitiesError({"error":{"message":"Response does not contain any layers."}});return;}var _1f=this._getLayerInfo(_1e);if(_1f){this.layerInfos=_1f.subLayers;if(!this.layerInfos||this.layerInfos.length==0){this.layerInfos=[_1f];}this.extent=_1f.extent;this.allExtents=_1f.allExtents;this.spatialReferences=_1f.spatialReferences;if(this.spatialReferences.length==0&&this.layerInfos.length>0){this.spatialReferences=this.layerInfos[0].spatialReferences;}}this.getMapURL=this._getCapabilitiesURL;var _20=_2.query("DCPType",this._getTag("GetMap",xml));if(_20&&_20.length>0){var _21=_2.query("HTTP",_20[0]);if(_21&&_21.length>0){var _22=_2.query("Get",_21[0]);if(_22&&_22.length>0){var _23=this._getAttributeValue("OnlineResource","xlink:href",_22[0],null);if(_23){if(_23.indexOf("&")==(_23.length-1)){_23=_23.substring(0,_23.length-1);}this.getMapURL=_23;}}}}this.getMapFormats=[];if(_2.query("Operation",xml).length==0){_2.forEach(_2.query("Format",this._getTag("GetMap",xml)),function(_24){this.getMapFormats.push(_24.text?_24.text:_24.textContent);},this);}else{_2.forEach(_2.query("Operation",xml),function(_25){if(_25.getAttribute("name")=="GetMap"){_2.forEach(_2.query("Format",_25),function(_26){this.getMapFormats.push(_26.text?_26.text:_26.textContent);},this);}},this);}if(!_2.some(this.getMapFormats,function(el){return el.indexOf(this.imageFormat)>-1;},this)){this.imageFormat=this.getMapFormats[0];}this._initLayer();},_getCapabilitiesError:function(_27,io){this.onError("GetCapabilities request for "+this._getCapabilitiesURL+" failed. ("+_2.toJson(_27)+")");},_getLayerInfo:function(_28){if(!_28){return null;}var _29=new esri.layers.WMSLayerInfo();_29.name="";_29.title="";_29.description="";_29.allExtents=[];_29.spatialReferences=[];_29.subLayers=[];var _2a=this._getTag("LatLonBoundingBox",_28);if(_2a){_29.allExtents[0]=this._getExtent(_2a,4326);}var _2b=this._getTag("EX_GeographicBoundingBox",_28);if(_2b){var _2c=new esri.geometry.Extent(0,0,0,0,new esri.SpatialReference({wkid:4326}));_2c.xmin=parseFloat(this._getTagValue("westBoundLongitude",_2b,0));_2c.ymin=parseFloat(this._getTagValue("southBoundLatitude",_2b,0));_2c.xmax=parseFloat(this._getTagValue("eastBoundLongitude",_2b,0));_2c.ymax=parseFloat(this._getTagValue("northBoundLatitude",_2b,0));_29.allExtents[0]=_2c;}_29.extent=_29.allExtents[0];var _2d=(_2.indexOf(["1.0.0","1.1.0","1.1.1"],this.version)>-1)?"SRS":"CRS";_2.forEach(_28.childNodes,function(_2e){if(_2e.nodeName=="Name"){_29.name=(_2e.text?_2e.text:_2e.textContent)||"";}else{if(_2e.nodeName=="Title"){_29.title=(_2e.text?_2e.text:_2e.textContent)||"";}else{if(_2e.nodeName=="Abstract"){_29.description=(_2e.text?_2e.text:_2e.textContent)||"";}else{if(_2e.nodeName=="BoundingBox"){srAttr=_2e.getAttribute(_2d);if(srAttr&&srAttr.indexOf("EPSG:")===0){wkid=parseInt(srAttr.substring(5));if(wkid!==0&&!isNaN(wkid)){var _2f;if(this.version=="1.3.0"){_2f=this._getExtent(_2e,wkid,this._useLatLong(wkid));}else{_2f=this._getExtent(_2e,wkid);}_29.allExtents[wkid]=_2f;if(!_29.extent){_29.extent=_2f;}}}else{if(srAttr&&srAttr.indexOf("CRS:")===0){wkid=parseInt(srAttr.substring(4));if(wkid!==0&&!isNaN(wkid)){if(this._CRS_TO_EPSG[wkid]){wkid=this._CRS_TO_EPSG[wkid];}_29.allExtents[wkid]=this._getExtent(_2e,wkid);}}else{wkid=parseInt(srAttr);if(wkid!==0&&!isNaN(wkid)){_29.allExtents[wkid]=this._getExtent(_2e,wkid);}}}}else{if(_2e.nodeName==_2d){var _30=_2e.text?_2e.text:_2e.textContent;var arr=_30.split(" ");_2.forEach(arr,function(val){if(val.indexOf(":")>-1){val=parseInt(val.split(":")[1]);}else{val=parseInt(val);}if(val!==84&&val!==0&&!isNaN(val)){if(!_2.some(_29.spatialReferences,function(el){return (el==val);})){_29.spatialReferences.push(val);}}},this);}else{if(_2e.nodeName=="Style"){var _31=this._getTag("LegendURL",_2e);if(_31){var _32=this._getTag("OnlineResource",_31);if(_32){_29.legendURL=_32.getAttribute("xlink:href");}}}else{if(_2e.nodeName==="Layer"){_29.subLayers.push(this._getLayerInfo(_2e));}}}}}}}},this);return _29;},_getImageFormat:function(_33){var _34=_33?_33.toLowerCase():"";switch(_34){case "jpg":return "image/jpeg";case "bmp":return "image/bmp";case "gif":return "image/gif";case "svg":return "image/svg+xml";default:return "image/png";}},getImageFormat:function(){var _35=this.imageFormat?this.imageFormat.toLowerCase():"";switch(_35){case "image/jpeg":return "jpg";case "image/bmp":return "bmp";case "image/gif":return "gif";case "image/svg+xml":return "svg";default:return "png";}},_getExtent:function(_36,_37,_38){var _39;if(_36){_39=new esri.geometry.Extent();var _3a=parseFloat(_36.getAttribute("minx"));var _3b=parseFloat(_36.getAttribute("miny"));var _3c=parseFloat(_36.getAttribute("maxx"));var _3d=parseFloat(_36.getAttribute("maxy"));if(_38){_39.xmin=isNaN(_3b)?((-1)*Number.MAX_VALUE):_3b;_39.ymin=isNaN(_3a)?((-1)*Number.MAX_VALUE):_3a;_39.xmax=isNaN(_3d)?Number.MAX_VALUE:_3d;_39.ymax=isNaN(_3c)?Number.MAX_VALUE:_3c;}else{_39.xmin=isNaN(_3a)?((-1)*Number.MAX_VALUE):_3a;_39.ymin=isNaN(_3b)?((-1)*Number.MAX_VALUE):_3b;_39.xmax=isNaN(_3c)?Number.MAX_VALUE:_3c;_39.ymax=isNaN(_3d)?Number.MAX_VALUE:_3d;}_39.spatialReference=new esri.SpatialReference({wkid:_37});}return _39;},_useLatLong:function(_3e){var _3f;for(var i=0;i<this._REVERSED_LAT_LONG_RANGES.length;i++){var _40=this._REVERSED_LAT_LONG_RANGES[i];if(_3e>=_40[0]&&_3e<=_40[1]){_3f=true;break;}}return _3f;},_getTag:function(_41,xml){var _42=_2.query(_41,xml);if(_42&&_42.length>0){return _42[0];}else{return null;}},_getTagValue:function(_43,xml,_44){var _45=_2.query(_43,xml);if(_45&&_45.length>0){if(_45[0].text){return _45[0].text;}else{return _45[0].textContent;}}else{return _44;}},_getAttributeValue:function(_46,_47,xml,_48){var _49=_2.query(_46,xml);if(_49&&_49.length>0){return _49[0].getAttribute(_47);}else{return _48;}},_checkVisibleLayersList:function(_4a){if(_4a&&_4a.length>0&&this.layerInfos&&this.layerInfos.length>0){if((typeof _4a[0])=="number"){var _4b=[];_2.forEach(_4a,function(pos){if(pos<this.layerInfos.length){_4b.push(this.layerInfos[pos].name);}},this);_4a=_4b;}}return _4a;},_stripParameters:function(url,_4c){var obj=esri.urlToObject(url);qs=[];for(var _4d in obj.query){if(_2.indexOf(_4c,_4d.toLowerCase())===-1){qs.push(_4d+"="+obj.query[_4d]);}}return obj.path+(qs.length?("?"+qs.join("&")):"");}});_2.declare("esri.layers.WMSLayerInfo",null,{name:null,title:null,description:null,extent:null,legendURL:null,subLayers:[],allExtents:[],spatialReferences:[],constructor:function(_4e){if(_4e){this.name=_4e.name;this.title=_4e.title;this.description=_4e.description;this.extent=_4e.extent;this.legendURL=_4e.legendURL;this.subLayers=_4e.subLayers?_4e.subLayers:[];this.allExtents=_4e.allExtents?_4e.allExtents:[];this.spatialReferences=_4e.spatialReferences?_4e.spatialReferences:[];}},clone:function(){var _4f={name:this.name,title:this.title,description:this.description,legendURL:this.legendURL};if(this.extent){_4f.extent=this.extent.getExtent();}_4f.subLayers=[];_2.forEach(this.subLayers,function(_50){_4f.subLayers.push(_50.clone());});_4f.allExtents=[];for(var _51 in this.allExtents){_51=parseInt(_51);if(!isNaN(_51)){_4f.allExtents[_51]=this.allExtents[_51].getExtent();}}_4f.spatialReferences=[];_2.forEach(this.spatialReferences,function(_52){_4f.spatialReferences.push(_52);});return _4f;}});});