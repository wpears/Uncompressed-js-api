/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define(["dijit","dojo","dojox","dojo/require!esri/layers/dynamic,esri/layers/agscommon,esri/utils"],function(_1,_2,_3){_2.provide("esri.layers.agsimageservice");_2.require("esri.layers.dynamic");_2.require("esri.layers.agscommon");_2.require("esri.utils");_2.declare("esri.layers.ArcGISImageServiceLayer",esri.layers.DynamicMapServiceLayer,{constructor:function(_4,_5){this._url=esri.urlToObject(_4);var _6=_5&&_5.imageServiceParameters;this.format=_6&&_6.format;this.interpolation=_6?_6.interpolation:null;this.compressionQuality=_6?_6.compressionQuality:null;this.bandIds=_6?_6.bandIds:null;this.mosaicRule=_6?_6.mosaicRule:null;this.renderingRule=_6?_6.renderingRule:null;this._params=_2.mixin({},this._url.query,{f:"image",interpolation:this.interpolation,format:this.format,compressionQuality:this.compressionQuality,bandIds:this.bandIds?this.bandIds.join(","):null},_6?_6.toJson():{});this._initLayer=_2.hitch(this,this._initLayer);this.useMapImage=(_5&&_5.useMapImage)||false;this._loadCallback=_5&&_5.loadCallback;var _7=_5&&_5.resourceInfo;if(_7){this._initLayer(_7);}else{esri.request({url:this._url.path,content:_2.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:this._initLayer,error:this._errorHandler});}},disableClientCaching:false,_initLayer:function(_8,io){this._findCredential();var _9=(this.credential&&this.credential.ssl)||(_8&&_8._ssl);if(_9){this._useSSL();}_2.mixin(this,_8);this.initialExtent=(this.fullExtent=this.extent=(new esri.geometry.Extent(_8.extent)));this.spatialReference=this.initialExtent.spatialReference;this.pixelSizeX=parseFloat(this.pixelSizeX);this.pixelSizeY=parseFloat(this.pixelSizeY);var i,il,_a=this.minValues,_b=this.maxValues,_c=this.meanValues,_d=this.stdvValues,bs=(this.bands=[]);for(i=0,il=this.bandCount;i<il;i++){bs[i]={min:_a[i],max:_b[i],mean:_c[i],stddev:_d[i]};}var _e=this.timeInfo;this.timeInfo=(_e&&_e.timeExtent)?new esri.layers.TimeInfo(_e):null;var _f=this.fields=[];var _10=_8.fields;if(_10){for(i=0;i<_10.length;i++){_f.push(new esri.layers.Field(_10[i]));}}this.version=_8.currentVersion;if(!this.version){var ver;if("fields" in _8||"objectIdField" in _8||"timeInfo" in _8){ver=10;}else{ver=9.3;}this.version=ver;}this.loaded=true;this.onLoad(this);var _11=this._loadCallback;if(_11){delete this._loadCallback;_11(this);}},getImageUrl:function(_12,_13,_14,_15){var sr=_12.spatialReference.wkid||_2.toJson(_12.spatialReference.toJson());delete this._params._ts;var _16=this._url.path+"/exportImage?";_2.mixin(this._params,{bbox:_12.xmin+","+_12.ymin+","+_12.xmax+","+_12.ymax,imageSR:sr,bboxSR:sr,size:_13+","+_14},this.disableClientCaching?{_ts:new Date().getTime()}:{});var _17=(this._params.token=this._getToken()),_18=esri._getProxiedUrl(_16+_2.objectToQuery(_2.mixin(this._params,{f:"image"})));if((_18.length>esri.config.defaults.io.postLength)||this.useMapImage){this._jsonRequest=esri.request({url:_16,content:_2.mixin(this._params,{f:"json"}),callbackParamName:"callback",load:function(_19,io){var _1a=_19.href;if(_17){_1a+=(_1a.indexOf("?")===-1?("?token="+_17):("&token="+_17));}_15(esri._getProxiedUrl(_1a));},error:this._errorHandler});}else{_15(_18);}},setInterpolation:function(_1b,_1c){this.interpolation=(this._params.interpolation=_1b);if(!_1c){this.refresh(true);}},setCompressionQuality:function(_1d,_1e){this.compressionQuality=(this._params.compressionQuality=_1d);if(!_1e){this.refresh(true);}},setBandIds:function(ids,_1f){this.bandIds=ids;this._params.bandIds=ids.join(",");if(!_1f){this.refresh(true);}},setDefaultBandIds:function(_20){this.bandIds=(this._params.bandIds=null);if(!_20){this.refresh(true);}},setDisableClientCaching:function(_21){this.disableClientCaching=_21;},setMosaicRule:function(_22,_23){this.mosaicRule=_22;this._params.mosaicRule=_2.toJson(_22.toJson());if(!_23){this.refresh(true);}},setRenderingRule:function(_24,_25){this.renderingRule=_24;this._params.renderingRule=_2.toJson(_24.toJson());if(!_25){this.refresh(true);}},setImageFormat:function(_26,_27){this.format=(this._params.format=_26);if(!_27){this.refresh(true);}},refresh:function(_28){if(_28){this.inherited(arguments);}else{var dc=this.disableClientCaching;this.disableClientCaching=true;this.inherited(arguments);this.disableClientCaching=dc;}},exportMapImage:function(_29,_2a){var m=esri.config.defaults.map,p=_2.mixin({size:m.width+","+m.height},this._params,_29?_29.toJson(this.normalization):{},{f:"json"});delete p._ts;this._exportMapImage(this._url.path+"/exportImage",p,_2a);}});_2.declare("esri.layers.ImageServiceParameters",null,{extent:null,width:null,height:null,imageSpatialReference:null,format:null,interpolation:null,compressionQuality:null,bandIds:null,timeExtent:null,mosaicRule:null,renderingRule:null,noData:null,toJson:function(_2b){var ext=this.bbox||this.extent;ext=ext&&_2b&&ext._normalize(true);var _2c=ext?(ext.spatialReference.wkid||_2.toJson(ext.spatialReference.toJson())):null,_2d=this.imageSpatialReference,_2e={bbox:ext?(ext.xmin+","+ext.ymin+","+ext.xmax+","+ext.ymax):null,bboxSR:_2c,size:(this.width!==null&&this.height!==null?this.width+","+this.height:null),imageSR:(_2d?(_2d.wkid||_2.toJson(_2d.toJson())):_2c),format:this.format,interpolation:this.interpolation,compressionQuality:this.compressionQuality,bandIds:this.bandIds?this.bandIds.join(","):null,mosaicRule:this.mosaicRule?_2.toJson(this.mosaicRule.toJson()):null,renderingRule:this.renderingRule?_2.toJson(this.renderingRule.toJson()):null,noData:this.noData};var _2f=this.timeExtent;_2e.time=_2f?_2f.toJson().join(","):null;return esri.filter(_2e,function(_30){if(_30!==null){return true;}});}});_2.mixin(esri.layers.ImageServiceParameters,{INTERPOLATION_BILINEAR:"RSP_BilinearInterpolation",INTERPOLATION_CUBICCONVOLUTION:"RSP_CubicConvolution",INTERPOLATION_MAJORITY:"RSP_Majority",INTERPOLATION_NEARESTNEIGHBOR:"RSP_NearestNeighbor"});_2.declare("esri.layers.MosaicRule",null,{method:null,where:null,sortField:null,sortValue:null,ascending:false,lockRasterIds:null,viewpoint:null,objectIds:null,operation:null,toJson:function(){var _31={mosaicMethod:this.method,where:this.where,sortField:this.sortField,sortValue:this.sortValue?_2.toJson(this.sortValue):null,ascending:this.ascending,lockRasterIds:this.lockRasterIds,viewpoint:this.viewpoint?this.viewpoint.toJson():null,fids:this.objectIds,mosaicOperation:this.operation};return esri.filter(_31,function(_32){if(_32!==null){return true;}});}});_2.mixin(esri.layers.MosaicRule,{METHOD_NONE:"esriMosaicNone",METHOD_CENTER:"esriMosaicCenter",METHOD_NADIR:"esriMosaicNadir",METHOD_VIEWPOINT:"esriMosaicViewpoint",METHOD_ATTRIBUTE:"esriMosaicAttribute",METHOD_LOCKRASTER:"esriMosaicLockRaster",METHOD_NORTHWEST:"esriMosaicNorthwest",METHOD_SEAMLINE:"esriMosaicSeamline",OPERATION_FIRST:"MT_FIRST",OPERATION_LAST:"MT_LAST",OPERATION_MIN:"MT_MIN",OPERATION_MAX:"MT_MAX",OPERATION_MEAN:"MT_MEAN",OPERATION_BLEND:"MT_BLEND"});_2.declare("esri.layers.RasterFunction",null,{functionName:null,"arguments":null,variableName:null,toJson:function(){var _33={rasterFunction:this.functionName,rasterFunctionArguments:this["arguments"],variableName:this.variableName};return esri.filter(_33,function(_34){if(_34!==null){return true;}});}});});