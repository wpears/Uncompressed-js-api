/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define(["dijit","dojo","dojox","dojo/require!dijit/_base/manager,esri/geometry,esri/utils,esri/fx,dojox/gfx/matrix,esri/layers/graphics,esri/dijit/InfoWindow"],function(_1,_2,_3){_2.provide("esri._coremap");_2.require("dijit._base.manager");_2.require("esri.geometry");_2.require("esri.utils");_2.require("esri.fx");_2.require("dojox.gfx.matrix");_2.require("esri.layers.graphics");_2.require("esri.dijit.InfoWindow");_2.declare("esri._CoreMap",null,(function(){var _4=esri.geometry.toMapPoint,_5=esri.geometry.toScreenPoint,dc=_2.connect,_6=_2.disconnect,dh=_2.hitch,ds=_2.style,_7=_2.indexOf,_8=_2.mixin,_9=esri.geometry.Point,_a=esri.geometry.Extent,_b=esri.layers.GraphicsLayer,_c=esri.geometry.Rect,_d=0,_e=esri.config.defaults.map;var _f=1000000,_10=0.75,_11=0.25,_12=3,_13=20,_14=40;function _15(_16,_17){var _18=_16.lods;_18.sort(function(l1,l2){if(l1.scale>l2.scale){return -1;}else{if(l1.scale<l2.scale){return 1;}}return 0;});var _19=[];_18=_2.filter(_18,function(l){if(_7(_19,l.scale)===-1){_19.push(l.scale);return true;}});var pl=(_17.lods=[]),l;_2.forEach(_18,function(lod,_1a){l=(pl[_1a]=new esri.layers.LOD(lod));l.level=_1a;});_17.tileInfo=new esri.layers.TileInfo(_8(_16,{lods:pl}));};return {resizeDelay:300,constructor:function(_1b,_1c){_8(this,{_internalLayerIds:[],_layers:[],_layerDivs:[],_layerSize:0,_clickHandles:[],_connects:[]});_8(this,{_zoomAnimDiv:null,_zoomAnim:null,_layersDiv:null,_firstLayerId:null,_delta:null,_gc:null,_cursor:null,_ratioW:1,_ratioH:1,_params:null});_8(this,{cursor:null,layerIds:[],graphicsLayerIds:[],graphics:null,loaded:false});_8(this,{__panning:false,__zooming:false,__container:null,root:null,__LOD:null,__tileInfo:null,__visibleRect:null,__visibleDelta:null});var _1d=(this.container=_2.byId(_1b));var id=(this.id=_2.attr(_1d,"id")||_1.getUniqueId(this.declaredClass));_2.addClass(_1d,"map");var box=_2.contentBox(_1d),dac=_2.addClass,dcr=_2.create;this.position=new _9(0,0);this._reposition();var _1e=(this.width=(box.w||_e.width));var _1f=(this.height=box.h||_e.height);if(box.w===0){ds(_1d,"width",_1e+"px");}if(box.h===0){ds(_1d,"height",_1f+"px");}var _20=(this.root=dcr("div",{id:id+"_root",style:{width:_1e+"px",height:_1f+"px"}}));dac(_20,"container");var _21=(this.__container=dcr("div",{id:id+"_container"},_20));ds(_21,"position","absolute");dac(_21,"container");_1d.appendChild(_20);var _22=(this._params=_8({slider:true,nav:false,extent:null,layer:null,scales:null,showInfoWindowOnClick:true,displayGraphicsOnPan:true,lods:null,tileInfo:null,wrapAround180:false,fitExtent:false},_1c||{}));this.wrapAround180=_22.wrapAround180;if(esri._isDefined(_22.resizeDelay)){this.resizeDelay=_22.resizeDelay;}if(_22.lods){_15({rows:512,cols:512,dpi:96,format:"JPEG",compressionQuality:75,origin:{x:-180,y:90},spatialReference:{wkid:4326},lods:_22.lods},_22);this.__tileInfo=_22.tileInfo;}var ext=(this.extent=_22.extent);this.spatialReference=(ext&&ext.spatialReference)?ext.spatialReference:null;this.__visibleRect=new _c(0,0,_1e,_1f);this.__visibleDelta=new _c(0,0,_1e,_1f);var _23=(this._layersDiv=dcr("div",{id:id+"_layers"}));dac(_23,"layersDiv");_21.appendChild(_23);this._zoomAnimDiv=dcr("div",{style:{position:"absolute"}});if(_22.infoWindow){this.infoWindow=_22.infoWindow;}else{var iw=(this.infoWindow=new esri.dijit.InfoWindow({map:this,title:"",id:id+"_infowindow"},dcr("div",null,_20)));iw.startup();iw._ootb=true;ds(iw.domNode,"zIndex",_14);}this._zoomStartHandler=dh(this,this._zoomStartHandler);this._zoomingHandler=dh(this,this._zoomingHandler);this._zoomEndHandler=dh(this,this._zoomEndHandler);this._panningHandler=dh(this,this._panningHandler);this._panEndHandler=dh(this,this._panEndHandler);this._endTranslate=dh(this,this._endTranslate);_2.addOnWindowUnload(this,this.destroy);},_cleanUp:function(){var iw=this.infoWindow;if(iw){if(iw._ootb){iw.destroy();}else{iw.unsetMap(this);}delete this.infoWindow;}var _24=this._connects,i;for(i=_24.length-1;i>=0;i--){_6(_24[i]);delete _24[i];}_6(this._tsTimeExtentChange_connect);this.setInfoWindowOnClick(false);_2.destroy(this.root);this.root=null;},_addLayer:function(_25,_26,_27){var id=(_25.id=_25.id||(_25 instanceof _b?_e.graphicsLayerNamePrefix:_e.layerNamePrefix)+(_d++));this._layers[id]=_25;var i;if(_26===this.layerIds||_26===this.graphicsLayerIds){i=this._layerSize;this._layerSize++;}_27=(_27===undefined||_27<0||_27>_26.length)?_26.length:_27;if(i===0){this._firstLayerId=id;}_26.splice(_27,0,id);var _28=dh(this,this._addLayerHandler),_29=this,_2a=this._connects,_2b=function(){if(_25.loaded){_28(_25);}else{_29[id+"_addtoken_load"]=dc(_25,"onLoad",_29,"_addLayerHandler");_29[id+"_addtoken_err"]=dc(_25,"onError",_29,function(_2c){_28(_25,_2c,_26);});}};if(this.loaded||i===0||(_25.loaded&&_7(this.graphicsLayerIds,id)===-1)){_2b();}else{_2a.push(dc(this,"onLoad",_2b));}return _25;},_addLayerHandler:function(_2d,_2e,_2f){var id=this.id,_30=_2d.id,_31=_7(_2d instanceof _b?this.graphicsLayerIds:this.layerIds,_30),_32=_31,_33=false,_34=this._params;_6(this[_30+"_addtoken_load"]);_6(this[_30+"_addtoken_err"]);if(_2e){delete this._layers[_30];if(_31!==-1){_2f.splice(_31,1);this.onLayerAddResult(_2d,_2e);}return;}if(_31===-1){_31=_7(this._internalLayerIds,_30);_32=_13+_31;_33=true;}if(_2d instanceof _b){var _35=_2d._setMap(this,this._gc._surface);_35.id=id+"_"+_30;this._layerDivs[_30]=_35;this._reorderLayers(this.graphicsLayerIds);if(_34.showInfoWindowOnClick){this._clickHandles.push(dc(_2d,"onClick",this,"_gClickHandler"));}}else{var _36=_2d._setMap(this,this._layersDiv,_32,this.__LOD);_36.id=id+"_"+_30;this._layerDivs[_30]=_36;this._reorderLayers(this.layerIds);if(!_33&&_2d.declaredClass.indexOf("VETiledLayer")!==-1){this._onBingLayerAdd(_2d);}}if(_30===this._firstLayerId){this.spatialReference=this.spatialReference||_2d.spatialReference;var _37=this.spatialReference;this.wrapAround180=(this.wrapAround180&&_37&&_37._isWrappable())?true:false;if(_2d.tileInfo){if(!this.__tileInfo){_15(_8({},_2d.tileInfo),_34);this.__tileInfo=_34.tileInfo;}else{var _38=this.__tileInfo.lods;this.__tileInfo=_8({},_2d.tileInfo);this.__tileInfo.lods=_38;}}if(this.wrapAround180){var _39=this.__tileInfo,_3a=_37._getInfo();if(!_39||Math.abs(_3a.origin[0]-_39.origin.x)>_3a.dx){this.wrapAround180=false;}if(this.wrapAround180&&_39){esri.TileUtils._addFrameInfo(_39,_3a);}}_34.units=_2d.units;this._gc=new esri.layers._GraphicsContainer();var gc=this._gc._setMap(this,this._layersDiv);gc.id=id+"_gc";this.graphics=new _b({id:id+"_graphics",displayOnPan:_34.displayGraphicsOnPan});this._addLayer(this.graphics,this._internalLayerIds,_13);}if(_2d===this.graphics){if(this.extent){var x=this._fixExtent(this.extent,_34.fitExtent);this.extent=x.extent;this.__LOD=x.lod;}var fli=this._firstLayerId;this._firstLayerId=null;this.__setExtent(this.extent||new _a(this._layers[fli].initialExtent||this._layers[fli].fullExtent),null,null,_34.fitExtent);this.loaded=true;this.infoWindow.setMap(this);this.onLoad(this);}if(!_33){this.onLayerAdd(_2d);this.onLayerAddResult(_2d);}_6(this[_30+"_addLayerHandler_connect"]);},_reorderLayers:function(_3b){var _3c=this.onLayerReorder,djp=_2.place,_3d=this._layerDivs,_3e=this._layers,_3f=this._gc?this._gc._surface.getEventSource():null;if(_3b===this.graphicsLayerIds){_2.forEach(_3b,function(id,i){var _40=_3d[id];if(_40){djp(_40.getEventSource(),_3f,i);_3c(_3e[id],i);}});}else{var g=this.graphics,gId=g?g.id:null,_41=this._layersDiv,_42;_2.forEach(_3b,function(id,i){_42=_3d[id];if(id!==gId&&_42){djp(_42,_41,i);_3c(_3e[id],i);}});if(_3f){_3f=esri.vml?_3f.parentNode:_3f;djp(_3f,_3f.parentNode,_3b.length);}}this.onLayersReordered([].concat(_3b));},_zoomStartHandler:function(){this.__zoomStart(this._zoomAnimDiv.startingExtent,this._zoomAnimDiv.anchor);},_zoomingHandler:function(_43){var rl=parseFloat(_43.left),rt=parseFloat(_43.top),_44=new _a(rl,rt-parseFloat(_43.height),rl+parseFloat(_43.width),rt,this.spatialReference),_45=this.extent.getWidth()/_44.getWidth();this.__zoom(_44,_45,this._zoomAnimDiv.anchor);},_zoomEndHandler:function(){var _46=this._zoomAnimDiv,_47=_46.extent,_48=this.extent.getWidth()/_47.getWidth();var _49=_46.anchor,_4a=_46.newLod,_4b=_46.levelChange;_46.extent=_46.anchor=_46.levelChange=_46.startingExtent=_46.newLod=this._delta=this._zoomAnim=null;this.__zoomEnd(_47,_48,_49,_4a,_4b);},_panningHandler:function(_4c){if(isNaN(parseFloat(_4c.left))||isNaN(parseFloat(_4c.top))){var _4d=Math.round,_4e=_2.style,_4f=this._panAnim.node;_4c.left=(-1*(this._delta.x-_4d(this.width/2)))+"px";_4c.top=(-1*(this._delta.y-_4d(this.height/2)))+"px";_4e(_4f,"left",_4c.left);_4e(_4f,"top",_4c.top);}var d=new _9(parseFloat(_4c.left),parseFloat(_4c.top)),dm=this.toMap(d);this.onPan(this.extent.offset(dm.x,dm.y),d);},_panEndHandler:function(_50){this.__panning=false;var _51=Math.round,_52=new _9(-_51(parseFloat(_50.style.left)),-_51(parseFloat(_50.style.top))),dx=_52.x,dy=_52.y,_53=this.__visibleRect,_54=this.__visibleDelta;_53.x+=-dx;_53.y+=-dy;_54.x+=-dx;_54.y+=-dy;ds(this._zoomAnimDiv,{left:"0px",top:"0px"});var _55=this.extent,rw=this._ratioW,rh=this._ratioH;_55=(this.extent=new _a(_55.xmin+(dx/rw),_55.ymin-(dy/rh),_55.xmax+(dx/rw),_55.ymax-(dy/rh),this.spatialReference));_52.setX(-_52.x);_52.setY(-_52.y);this._delta=this._panAnim=null;this.onPanEnd(_55,_52);this.onExtentChange(_55,_52,false,this.__LOD);},_fixExtent:function(_56,fit){var _57=this._reshapeExtent(_56),_58=1+_11;while(fit===true&&(_57.extent.getWidth()<_56.getWidth()||_57.extent.getHeight()<_56.getHeight())&&_57.lod.level>0&&_58<=_12){_57=this._reshapeExtent(_56.expand(_58));_58+=_11;}return _57;},_getFrameWidth:function(){var _59=-1,_5a=this.spatialReference._getInfo();if(this.__LOD){var _5b=this.__LOD._frameInfo;if(_5b){_59=_5b[3];}}else{if(_5a){_59=Math.round((2*_5a.valid[1])/(this.extent.getWidth()/this.width));}}return _59;},_reshapeExtent:function(_5c){var w=_5c.getWidth(),h=_5c.getHeight(),r=w/h,_5d=this.width/this.height,dw=0,dh=0;if(this.width>this.height){if(w>h){if(_5d>r){dw=(h*_5d)-w;}else{dh=(w/_5d)-h;}}else{if(w<h){dw=(h*_5d)-w;}else{dw=(h*_5d)-w;}}}else{if(this.width<this.height){if(w>h){dh=(w/_5d)-h;}else{if(w<h){if(_5d>r){dw=(h*_5d)-w;}else{dh=(w/_5d)-h;}}else{dh=(w/_5d)-h;}}}else{if(w<h){dw=h-w;}else{if(w>h){dh=(w/_5d)-h;}}}}if(dw){_5c.xmin-=dw/2;_5c.xmax+=dw/2;}if(dh){_5c.ymin-=dh/2;_5c.ymax+=dh/2;}return this._getAdjustedExtent(_5c);},_getAdjustedExtent:function(_5e){if(this.__tileInfo){return esri.TileUtils.getCandidateTileInfo(this,this.__tileInfo,_5e);}else{return {extent:_5e};}},_fixedPan:function(dx,dy){this._extentUtil(null,{dx:dx,dy:dy});},_gClickHandler:function(evt){var _5f=evt.graphic,iw=this.infoWindow;if(_5f._getEffInfoTemplate()&&iw){_2.stopEvent(evt);var _60=_5f.geometry,_61=(_60&&_60.type==="point")?_60:evt.mapPoint;iw.setTitle(_5f.getTitle());iw.setContent(_5f.getContent());iw.show(_61);}},_onBingLayerAdd:function(_62){this["__"+_62.id+"_vis_connect"]=_2.connect(_62,"onVisibilityChange",this,"_toggleBingLogo");this._toggleBingLogo(_62.visible);},_onBingLayerRemove:function(_63){_2.disconnect(this["__"+_63.id+"_vis_connect"]);delete this["__"+_63.id+"_vis_connect"];var _64=this.layerIds;var _65=_2.some(_64,function(_66){var _67=this._layers[_66];return _67&&_67.visible&&_67.declaredClass.indexOf("VETiledLayer")!==-1;},this);this._toggleBingLogo(_65);},_toggleBingLogo:function(_68){if(_68&&!this._bingLogo){var _69={left:(this._mapParams&&this._mapParams.nav?"25px":"")};if(_2.isIE===6){_69.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(enabled='true', sizingMethod='crop', src='"+_2.moduleUrl("esri")+"../../images/map/logo-med.png"+"')";}var _6a=this._bingLogo=_2.create("div",{style:_69},this.root);_2.addClass(_6a,"bingLogo-lg");}else{if(!_68&&this._bingLogo){_2.destroy(this._bingLogo);delete this._bingLogo;}}},__panStart:function(x,y){var _6b=this._zoomAnim,_6c=this._panAnim;if(_6b&&_6b._active){_6b.stop();_6b._fire("onEnd",[_6b.node]);}else{if(_6c&&_6c._active){_6c.stop();this._panAnim=null;var _6d=_6c.curve.getValue(_6c._getStep()),rl=Math.round(parseFloat(_6d.left)),rt=Math.round(parseFloat(_6d.top)),_6e=this._dragOrigin;this.__pan(rl,rt);if(_6e){_6e.x-=rl;_6e.y-=rt;}return;}}this.__panning=true;this.onPanStart(this.extent,new _9(x,y));},__pan:function(dx,dy){var _6f=this.extent,rw=this._ratioW,rh=this._ratioH;this.onPan(new _a(_6f.xmin-(dx/rw),_6f.ymin+(dy/rh),_6f.xmax-(dx/rw),_6f.ymax+(dy/rh),this.spatialReference),new _9(dx,dy));},__panEnd:function(dx,dy){var _70=this.__visibleRect,_71=this.__visibleDelta;_70.x+=dx;_70.y+=dy;_71.x+=dx;_71.y+=dy;var d=new _9(dx,dy),_72=this.extent,rw=this._ratioW,rh=this._ratioH;_72=(this.extent=new _a(_72.xmin-(dx/rw),_72.ymin+(dy/rh),_72.xmax-(dx/rw),_72.ymax+(dy/rh),this.spatialReference));this.__panning=false;this.onPanEnd(_72,d);this.onExtentChange(_72,d,false,this.__LOD);},__zoomStart:function(_73,_74){this.__zooming=true;this.onZoomStart(_73,1,_74,this.__LOD?this.__LOD.level:null);},__zoom:function(_75,_76,_77){this.onZoom(_75,_76,_77);},__zoomEnd:function(_78,_79,_7a,lod,_7b){ds(this._layersDiv,{left:"0px",top:"0px"});this._delta=new _9(0,0);this.__visibleRect.x=(this.__visibleRect.y=0);_78=(this.extent=new _a(_78));this.__LOD=lod;this._ratioW=this.width/_78.getWidth();this._ratioH=this.height/_78.getHeight();var _7c=this._delta;this._delta=null;this.__zooming=false;this.onZoomEnd(_78,_79,_7a,lod?lod.level:null);this.onExtentChange(_78,_7c,_7b,lod);},_extentUtil:function(_7d,pan,_7e,fit,_7f){var _80,_81,_82,_83,_84,_85,dx,dy,_86=this.width,_87=this.height;if(_7d){_80=_7d.numLevels;_81=_7d.targetLevel;_82=_7d.factor;_83=_7d.mapAnchor;_84=_7d.screenAnchor;_85=_7d.mapCenter;}if(pan){dx=pan.dx;dy=pan.dy;_85=pan.mapCenter;}var _88=this._panAnim,_89=this._stopAnim(),_8a=_89?_89.divExtent:this.extent,_8b=this.__tileInfo,_8c,_8d,ewd,eht;if(_88&&_83&&_84){_83=_4(this.extent,_86,_87,_84);}if(_89&&_83&&_84){_83=_4(_89.divExtent,_86,_87,_84);}if(esri._isDefined(_81)){if(_8b){var _8e=this.getNumLevels()-1;if(_81<0){_81=0;}else{if(_81>_8e){_81=_8e;}}_80=_81-(_89?_89.level:this.getLevel());}else{_80=_81>0?-1:1;}}if(_7e){}else{if(esri._isDefined(_80)){var _8f;if(_8b){var _90=_89?_89.level:this.getLevel();_8f=this.__getExtentForLevel(_90+_80,_85,_8a).extent;}else{var _91=_89?_89.end:this.extent;_8f=_91.expand(_80>0?0.5*_80:2*-_80);}if(_8f){if(_85){_7e=_8f;}else{var _92=_83||_8a.getCenter(),_93=_8a.ymax-((_8f.getHeight()-_8a.getHeight())*(_92.y-_8a.ymax)/_8a.getHeight());_8c=_8a.xmin-((_8f.getWidth()-_8a.getWidth())*(_92.x-_8a.xmin)/_8a.getWidth());_7e=new _a(_8c,_93-_8f.getHeight(),_8c+_8f.getWidth(),_93,this.spatialReference);}}}else{if(esri._isDefined(_82)){_7e=_8a.expand(_82);}else{if(dx||dy){if(_89){var end=_89.end,c1=end.getCenter(),c2=_5(end,_86,_87,c1);c2.x+=dx;c2.y+=dy;c2=_4(end,_86,_87,c2);_7e=end.offset(c2.x-c1.x,c2.y-c1.y);}else{var _94=new _9((_86/2)+dx,(_87/2)+dy),_95=_4(_8a,_86,_87,_94);ewd=_8a.getWidth();eht=_8a.getHeight();_8c=_95.x-(ewd/2);_8d=_95.y-(eht/2);_7e=new _a(_8c,_8d,_8c+ewd,_8d+eht);}}}}}if(!_7e){if(_85){var ext=_89?_89.end:_8a;ewd=ext.getWidth();eht=ext.getHeight();_8c=_85.x-(ewd/2);_8d=_85.y-(eht/2);_7e=new _a(_8c,_8d,_8c+ewd,_8d+eht);}else{if(_89){_7e=_89.end;}}}if(_7e){this.__setExtent(_7e,null,_84,fit,_89,_7f);}},__setExtent:function(_96,_97,_98,fit,_99,_9a){try{if(this._firstLayerId){this.extent=_96;return;}var _9b=true,ext=_99?_99.divExtent:this.extent,_9c=this._fixExtent(_96,fit||false);_96=_9c.extent;var _9d=_96.getWidth(),_9e=_96.getHeight(),_9f=Math.round;if(ext){var tw=_9f(ext.getWidth()*_f),w=_9f(_9d*_f),th=_9f(ext.getHeight()*_f),h=_9f(_9e*_f);_9b=(tw!==w)||(th!==h);}var _a0,end,_a1,_a2,_a3=_99&&_99.rect,_a4=_99&&_99.divExtent;if(_e.zoomDuration&&_9b&&ext){_a4=_a4||new _a(ext);_a3=_a3||{left:ext.xmin,top:ext.ymax,width:ext.getWidth(),height:ext.getHeight()};end={left:_96.xmin,top:_96.ymax,width:_9d,height:_9e};_a1=_a3.width/end.width;_a2=_a3.height/end.height;var mtl=new _9(_96.xmin,_96.ymax),mbl=new _9(_96.xmin,_96.ymin),etl=new _9(this.extent.xmin,this.extent.ymax),ebl=new _9(this.extent.xmin,this.extent.ymin);_a0=esri.geometry.getLineIntersection(etl,mtl,ebl,mbl);if(!_a0&&!_99){_9b=false;}}this._ratioW=this.width/_9d;this._ratioH=this.height/_9e;var _a5=this._zoomAnimDiv;if(_9b){ds(this._layersDiv,{left:"0px",top:"0px"});_97=new _9(0,0);this.__visibleRect.x=(this.__visibleRect.y=0);if(_a3&&end){this._delta=_97;_a5.id="_zAD";_a5.startingExtent=_a4;_a5.extent=_96;_a5.levelChange=_9b;_a5.newLod=_9c.lod;if(_98){_a5.anchor=_98;}else{if(!_a0&&_99){_a5.anchor=_99.anchor;}else{_a5.anchor=_5(this.extent,this.width,this.height,_a0);}}this._zoomAnim=esri.fx.resize({node:_a5,start:_a3,end:end,duration:_e.zoomDuration,rate:_e.zoomRate,beforeBegin:!_99?this._zoomStartHandler:null,onAnimate:this._zoomingHandler,onEnd:this._zoomEndHandler}).play();this._fireOnScale(this.extent.getWidth()/_96.getWidth(),_a5.anchor);}else{this.extent=_96;this.onExtentChange(this.extent,_97,_9b,(this.__LOD=_9c.lod));}}else{if(!this.__panning){if(this.loaded===false||_9a){this.extent=_96;this.onExtentChange(this.extent,_97,_9b,(this.__LOD=_9c.lod));}else{this.__panning=true;_a3=new _c(0,0,this.width,this.height,this.spatialReference).getCenter();_a3.x=_9f(_a3.x);_a3.y=_9f(_a3.y);this.onPanStart(this.extent,new _9(0,0));var _a6=(this._delta=this.toScreen(_96.getCenter()));this._panAnim=esri.fx.slideTo({node:_a5,left:_a3.x-_a6.x,top:_a3.y-_a6.y,duration:_e.panDuration,rate:_e.panRate,onAnimate:this._panningHandler,onEnd:this._panEndHandler});this._panAnim.play();}}}}catch(e){console.log(e.stack);console.error(e);}},_fireOnScale:function(_a7,_a8,_a9){if(this.navigationMode==="css-transforms"){var vd=this.__visibleDelta;this.onScale(_3.gfx.matrix.scaleAt(_a7,{x:-1*((this.width/2)-(_a8.x-vd.x)),y:-1*((this.height/2)-(_a8.y-vd.y))}),_a9);}},_stopAnim:function(){var _aa=this._zoomAnim,_ab=this._panAnim;if(_aa&&_aa._active){_aa.stop();var _ac=_aa.curve.getValue(_aa._getStep()),rl=parseFloat(_ac.left),rt=parseFloat(_ac.top),_ad=_aa.node;return {anchor:_ad.anchor,start:_ad.startingExtent,end:_ad.extent,level:_ad.newLod&&_ad.newLod.level,rect:_ac,divExtent:new _a(rl,rt-parseFloat(_ac.height),rl+parseFloat(_ac.width),rt,this.spatialReference)};}else{if(_ab&&_ab._active){_ab.stop();_ab._fire("onEnd",[_ab.node]);}}},__getExtentForLevel:function(_ae,_af,_b0){var ti=this.__tileInfo;_b0=_b0||this.extent;_af=_af||_b0.getCenter();if(ti){var _b1=ti.lods;if(_ae<0||_ae>=_b1.length){return {};}var lod=_b1[_ae],_b2=this.width*lod.resolution/2,_b3=this.height*lod.resolution/2;return {extent:new _a(_af.x-_b2,_af.y-_b3,_af.x+_b2,_af.y+_b3,_af.spatialReference),lod:lod};}else{return {extent:_b0.expand(_ae).centerAt(_af)};}},__scaleExtent:function(_b4,_b5,_b6){var _b7=_b6||_b4.getCenter();var _b8=_b4.expand(_b5),_b9=_b4.xmin-((_b8.getWidth()-_b4.getWidth())*(_b7.x-_b4.xmin)/_b4.getWidth()),_ba=_b4.ymax-((_b8.getHeight()-_b4.getHeight())*(_b7.y-_b4.ymax)/_b4.getHeight());return new _a(_b9,_ba-_b8.getHeight(),_b9+_b8.getWidth(),_ba,_b4.spatialReference);},_jobs:0,_incr:function(){if((++this._jobs)===1){this.updating=true;this.onUpdateStart();}},_decr:function(){var _bb=--this._jobs;if(!_bb){this.updating=false;this.onUpdateEnd();}else{if(_bb<0){this._jobs=0;}}},onUpdateStart:function(){},onUpdateEnd:function(){},onLoad:function(){this._setClipRect();},onUnload:function(){},onExtentChange:function(a,b,_bc){if(_bc){this._setClipRect();}},onTimeExtentChange:function(){},onLayerAdd:function(){},onLayerAddResult:function(){},onLayersAddResult:function(){},onLayerRemove:function(){},onLayersRemoved:function(){},onLayerReorder:function(){},onLayersReordered:function(){},onPanStart:function(){},onPan:function(){},onPanEnd:function(){},onScale:function(){},onZoomStart:function(){},onZoom:function(){},onZoomEnd:function(){},onResize:function(){this._setClipRect();},onReposition:function(){},destroy:function(){if(!this._destroyed){this.removeAllLayers();this._cleanUp();if(this._gc){this._gc._cleanUp();}this._destroyed=true;this.onUnload(this);}},setCursor:function(_bd){ds(this.__container,"cursor",(this.cursor=_bd));},setMapCursor:function(c){this.setCursor((this._cursor=c));},resetMapCursor:function(){this.setCursor(this._cursor);},setInfoWindow:function(_be){var iw=this.infoWindow;if(iw){iw.unsetMap(this);}this.infoWindow=_be;if(this.loaded&&_be){_be.setMap(this);}},setInfoWindowOnClick:function(_bf){var _c0=this._params;if(_bf){if(!_c0.showInfoWindowOnClick){var _c1=[this.graphics].concat(_2.map(this.graphicsLayerIds,this.getLayer,this));_2.map(_c1,function(_c2){if(_c2&&_c2.loaded){this._clickHandles.push(dc(_c2,"onClick",this,"_gClickHandler"));}},this);}}else{_2.forEach(this._clickHandles,_6);this._clickHandles=[];}_c0.showInfoWindowOnClick=_bf;},getInfoWindowAnchor:function(pt){var w2=this.width/2,h2=this.height/2,_c3;if(pt.y<h2){_c3="LOWER";}else{_c3="UPPER";}if(pt.x<w2){return esri.dijit.InfoWindow["ANCHOR_"+_c3+"RIGHT"];}else{return esri.dijit.InfoWindow["ANCHOR_"+_c3+"LEFT"];}},toScreen:function(pt,_c4){return _5(this.extent,this.width,this.height,pt,_c4);},toMap:function(pt){return _4(this.extent,this.width,this.height,pt);},addLayer:function(_c5,_c6){return this._addLayer(_c5,_c5 instanceof _b?this.graphicsLayerIds:this.layerIds,_c6);},addLayers:function(_c7){var _c8=[],_c9=_c7.length,_ca,i,len=_c7.length;var _cb=function(_cc,_cd){if(_2.indexOf(_c7,_cc)!==-1){_c9--;_c8.push({"layer":_cc,"success":!_cd,"error":_cd});if(!_c9){_2.disconnect(_ca);this.onLayersAddResult(_c8);}}};_ca=_2.connect(this,"onLayerAddResult",_cb);for(i=0;i<len;i++){this.addLayer(_c7[i]);}return this;},removeLayer:function(_ce,_cf){var id=_ce.id,ids=_ce instanceof _b?this.graphicsLayerIds:this.layerIds,i=_7(ids,id);if(i>=0){ids.splice(i,1);if(_ce instanceof _b){_6(this["_gl_"+_ce.id+"_click_connect"]);if(_ce.loaded){_ce._unsetMap(this,this._gc._surface);}}else{if(_ce.loaded){_ce._unsetMap(this,this._layersDiv);if(_ce.declaredClass.indexOf("VETiledLayer")!==-1){this._onBingLayerRemove(_ce);}}}delete this._layers[id];delete this._layerDivs[id];if(!_cf){this._reorderLayers(ids);}this.onLayerRemove(_ce);}},removeAllLayers:function(){var ids=this.layerIds,i;for(i=ids.length-1;i>=0;i--){this.removeLayer(this._layers[ids[i]],1);}ids=this.graphicsLayerIds;for(i=ids.length-1;i>=0;i--){this.removeLayer(this._layers[ids[i]],1);}this.onLayersRemoved();},reorderLayer:function(_d0,_d1){if(_2.isString(_d0)){_2.deprecated(this.declaredClass+": "+esri.bundle.map.deprecateReorderLayerString,null,"v2.0");_d0=this.getLayer(_d0);}var id=_d0.id,ids=_d0 instanceof _b?this.graphicsLayerIds:this.layerIds;if(_d1<0){_d1=0;}else{if(_d1>=ids.length){_d1=ids.length-1;}}var i=_7(ids,id);if(i===-1||i===_d1){return;}ids.splice(i,1);ids.splice(_d1,0,id);this._reorderLayers(ids);},getLayer:function(id){return this._layers[id];},setExtent:function(_d2,fit){_d2=new esri.geometry.Extent(_d2.toJson());var _d3=_d2.getWidth(),_d4=_d2.getHeight();if(_d3===0&&_d4===0){this.centerAt(new esri.geometry.Point({x:_d2.xmin,y:_d2.ymin,spatialReference:_d2.spatialReference&&_d2.spatialReference.toJson()}));}else{this._extentUtil(null,null,_d2,fit);}},centerAt:function(_d5){this._extentUtil(null,{mapCenter:_d5});},centerAndZoom:function(_d6,_d7){this._extentUtil({targetLevel:_d7,mapCenter:_d6});},getNumLevels:function(){return this.__tileInfo?this.__tileInfo.lods.length:0;},getLevel:function(){return this.__LOD?this.__LOD.level:-1;},setLevel:function(_d8){this._extentUtil({targetLevel:_d8});},translate:function(dx,dy){dx=dx||0;dy=dy||0;if(!this._txTimer){this._tx=this._ty=0;var _d9=this.toScreen(this.extent.getCenter());this.__panStart(_d9.x,_d9.y);}this._tx+=dx;this._ty+=dy;this.__pan(this._tx,this._ty);clearTimeout(this._txTimer);this._txTimer=setTimeout(this._endTranslate,150);},_endTranslate:function(){clearTimeout(this._txTimer);this._txTimer=null;var dx=this._tx,dy=this._ty;this._tx=this._ty=0;this.__panEnd(dx,dy);},setTimeExtent:function(_da){this.timeExtent=_da;var arg=_da?new esri.TimeExtent(_da.startTime,_da.endTime):null;this.onTimeExtentChange(arg);},setTimeSlider:function(_db){if(this.timeSlider){_6(this._tsTimeExtentChange_connect);this._tsTimeExtentChange_connect=null;this.timeSlider=null;}if(_db){this.timeSlider=_db;this.setTimeExtent(_db.getCurrentTimeExtent());this._tsTimeExtentChange_connect=dc(_db,"onTimeExtentChange",this,"setTimeExtent");}},resize:function(_dc){var _dd=this,_de=function(){clearTimeout(_dd._resizeT);_dd.reposition();_dd._resize();};clearTimeout(_dd._resizeT);if(_dc===true){_de();}else{_dd._resizeT=setTimeout(_de,_dd.resizeDelay);}},_resize:function(){var w=this.width,h=this.height,box=_2.contentBox(this.container);if(w===box.w&&h===box.h){return;}var _df=this._zoomAnim||this._panAnim;if(_df){_df.stop();_df._fire("onEnd",[_df.node]);}ds(this.root,{width:(this.width=box.w)+"px",height:(this.height=box.h)+"px"});var wd=this.width,ht=this.height;this.__visibleRect.update(this.__visibleRect.x,this.__visibleRect.y,wd,ht);this.__visibleDelta.update(this.__visibleDelta.x,this.__visibleDelta.y,wd,ht);var r=esri.geometry._extentToRect(this.extent),ne=(esri.geometry._rectToExtent(new _c(r.x,r.y,r.width*(wd/w),r.height*(ht/h),this.spatialReference)));this.onResize(ne,wd,ht);this._extentUtil(null,null,ne,null,true);},reposition:function(){this._reposition();this.onReposition(this.position.x,this.position.y);},_reposition:function(){var pos=_2.coords(this.container,true),_e0=_2._getPadBorderExtents(this.container);this.position.update(pos.x+_e0.l,pos.y+_e0.t);},_setClipRect:function(){delete this._clip;var _e1=_2.isIE?"rect(auto,auto,auto,auto)":null;if(this.wrapAround180){var _e2=this.width,_e3=this.height,_e4=this._getFrameWidth(),_e5=_e2-_e4;if(_e5>0){var _e6=_e5/2;_e1="rect(0px,"+(_e6+_e4)+"px,"+_e3+"px,"+_e6+"px)";var _e7=this.extent.getWidth(),_e8=_e7*(_e4/_e2);this._clip=[(_e7-_e8)/2,_e8];}}ds(this.__container,"clip",_e1);},_getAvailExtent:function(){var _e9=this.extent,_ea=this._clip;if(_ea){if(!_e9._clip){var _eb=new esri.geometry._extentToRect(_e9);_eb.width=_ea[1];_eb.x=_eb.x+_ea[0];_e9._clip=_eb.getExtent();}return _e9._clip;}return _e9;},panUp:function(){this._fixedPan(0,this.height*-_10);},panUpperRight:function(){this._fixedPan(this.width*_10,this.height*-_10);},panRight:function(){this._fixedPan(this.width*_10,0);},panLowerRight:function(){this._fixedPan(this.width*_10,this.height*_10);},panDown:function(){this._fixedPan(0,this.height*_10);},panLowerLeft:function(){this._fixedPan(this.width*-_10,this.height*_10);},panLeft:function(){this._fixedPan(this.width*-_10,0);},panUpperLeft:function(){this._fixedPan(this.width*-_10,this.height*-_10);},enableSnapping:function(_ec){if(!_ec){_ec={};}if(_ec.declaredClass==="esri.SnappingManager"){this.snappingManager=_ec;}else{this.snappingManager=new esri.SnappingManager(_2.mixin({map:this},_ec));}return this.snappingManager;},disableSnapping:function(){if(this.snappingManager){this.snappingManager.destroy();}this.snappingManager=null;}};}()));});