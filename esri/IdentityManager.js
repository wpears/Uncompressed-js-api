/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define(["dijit","dojo","dojox","dojo/require!dijit/Dialog,dijit/form/Button,dijit/form/ValidationTextBox,esri/utils,esri/IdentityManagerBase"],function(_1,_2,_3){_2.provide("esri.IdentityManager");_2.require("dijit.Dialog");_2.require("dijit.form.Button");_2.require("dijit.form.ValidationTextBox");_2.require("esri.utils");_2.require("esri.IdentityManagerBase");_2.declare("esri.IdentityManager",[esri.IdentityManagerBase],{constructor:function(_4){_2.mixin(this,_4);},_dialogContent:"<div class='dijitDialogPaneContentArea'>"+"<div style='padding-bottom: 5px; word-wrap: break-word;'>${info}</div>"+"<div style='margin: 0px; padding: 0px; height: 10px;'></div>"+"<div class='esriErrorMsg' style='display: none; color: white; background-color: #D46464; text-align: center; padding-top: 3px; padding-bottom: 3px;'>${invalidUser}</div>"+"<div style='margin: 0px; padding: 0px; height: 10px;'></div>"+"<table style='width: 100%;'>"+"<tr>"+"<td><label>${lblUser}</label><br/>"+"<input data-dojo-type='dijit.form.ValidationTextBox' data-dojo-props='type:\"text\", \"class\":\"esriIdUser\", required:true, trim:true, style:\"width: 100%;\"' /></td>"+"</tr>"+"<tr>"+"<td><label>${lblPwd}</label><br/>"+"<input data-dojo-type='dijit.form.ValidationTextBox' data-dojo-props='type:\"password\", \"class\":\"esriIdPwd\", required:true, style:\"width: 100%;\"' /></td>"+"</tr>"+"</table>"+"</div>"+"<div class='dijitDialogPaneActionBar'>"+"<button data-dojo-type='dijit.form.Button' data-dojo-props='type:\"button\", \"class\":\"esriIdSubmit\"'>${lblOk}</button>"+"<button data-dojo-type='dijit.form.Button' data-dojo-props='type:\"button\", \"class\":\"esriIdCancel\"'>${lblCancel}</button>"+"</div>",onDialogCreate:function(){},onDialogCancel:function(){},signIn:function(_5,_6,_7){if(!this._nls){this._nls=esri.bundle.identity;}if(!this._loginDialog){this._loginDialog=(this.dialog=this._createLoginDialog());this.onDialogCreate();}var _8=this._loginDialog,_9=_7&&_7.error,_a=_7&&_7.token,_b=new _2.Deferred(function(){_8.onCancel();});if(_8.open){var _c=new Error("BUSY");_c.code="IdentityManager."+1;_c.log=_2.config.isDebug;_b.errback(_c);return _b;}esri.hide(_8.errMsg_);if(_9){if(_9.code==403&&_a){_2.attr(_8.errMsg_,"innerHTML",this._nls.forbidden);esri.show(_8.errMsg_);}}_8.dfd_=_b;_8.serverInfo_=_6;_8.resUrl_=_5;_8.admin_=_7&&_7.isAdmin;_2.attr(_8.resLink_,{"title":_5,"innerHTML":"("+(this.getResourceName(_5)||this._nls.lblItem)+")"});_2.attr(_8.serverLink_,{"title":_6.server,"innerHTML":(_6.server.toLowerCase().indexOf("arcgis.com")!==-1?"ArcGIS Online":_6.server)+" "});_8.txtPwd_.set("value","");_8.show();return _b;},_createLoginDialog:function(){var _d=this._nls,_e=esri.substitute(_d,this._dialogContent);_e=esri.substitute({resource:"<span class='resLink' style='word-wrap: break-word;'></span>",server:"<span class='serverLink' style='word-wrap: break-word;'></span>"},_e);var _f=new _1.Dialog({title:_d.title,content:_e,"class":"esriSignInDialog",style:"width: 18em;",esriIdMgr_:this,keypressed_:function(evt){if(evt.charOrCode===_2.keys.ENTER){this.execute_();}},execute_:function(){var usr=this.txtUser_.get("value"),pwd=this.txtPwd_.get("value"),dfd=this.dfd_,_f=this;if(!usr||!pwd){return;}this.btnSubmit_.set("label",_d.lblSigning);var _10=esri.id.findCredential(_f.serverInfo_.server,usr),_11=function(_12){_f.btnSubmit_.set("label",_d.lblOk);_f.btnSubmit_.set("disabled",false);esri.hide(_f.errMsg_);_f.hide();_1.Dialog._DialogLevelManager.hide(_f);var _13=_f.serverInfo_;_f.dfd_=_f.serverInfo_=_f.generateDfd_=_f.resUrl_=null;var _14,_15,_16=_10,ssl;if(_12){_14=_12.token;_15=esri._isDefined(_12.expires)?Number(_12.expires):null;ssl=!!_12.ssl;if(_16){_16.userId=usr;_16.token=_14;_16.expires=_15;_16.validity=_13.shortLivedTokenValidity;_16.ssl=ssl;}else{_16=new esri.Credential({userId:usr,server:_13.server,token:_14,expires:_15,ssl:ssl,isAdmin:_f.admin_,validity:_13.shortLivedTokenValidity});}}dfd.callback(_16);};if(_10&&!_10._enqueued){_11();return;}_f.btnSubmit_.set("disabled",true);_f.generateDfd_=esri.id.generateToken(this.serverInfo_,{username:usr,password:pwd},{isAdmin:this.admin_}).addCallback(_11).addErrback(function(_17){_f.btnSubmit_.set("disabled",false);_f.generateDfd_=null;_f.btnSubmit_.set("label",_d.lblOk);_2.attr(_f.errMsg_,"innerHTML",(_17&&_17.code)?_d.invalidUser:_d.noAuthService);esri.show(_f.errMsg_);});},cancel_:function(){if(_f.generateDfd_){_f.generateDfd_.cancel();}var dfd=_f.dfd_,_18=_f.resUrl_,_19=_f.serverInfo_;_f.btnSubmit_.set("disabled",false);_f.dfd_=_f.serverInfo_=_f.generateDfd_=_f.resUrl_=null;esri.hide(_f.errMsg_);_1.Dialog._DialogLevelManager.hide(_f);_f.esriIdMgr_.onDialogCancel({resourceUrl:_18,serverInfo:_19});var err=new Error("ABORTED");err.code="IdentityManager."+2;err.log=_2.config.isDebug;dfd.errback(err);}});var _1a=_f.domNode;_f.txtUser_=_1.byNode(_2.query(".esriIdUser",_1a)[0]);_f.txtPwd_=_1.byNode(_2.query(".esriIdPwd",_1a)[0]);_f.btnSubmit_=_1.byNode(_2.query(".esriIdSubmit",_1a)[0]);_f.btnCancel_=_1.byNode(_2.query(".esriIdCancel",_1a)[0]);_f.resLink_=_2.query(".resLink",_1a)[0];_f.serverLink_=_2.query(".serverLink",_1a)[0];_f.errMsg_=_2.query(".esriErrorMsg",_1a)[0];_f.connect(_f.txtUser_,"onKeyPress",_f.keypressed_);_f.connect(_f.txtPwd_,"onKeyPress",_f.keypressed_);_f.connect(_f.btnSubmit_,"onClick",_f.execute_);_f.connect(_f.btnCancel_,"onClick",_f.onCancel);_f.connect(_f,"onCancel",_f.cancel_);return _f;}});esri.id=new esri.IdentityManager();});